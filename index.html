<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Lý Chi Phí Làm Vườn SR2526</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root { --garden-green: #2e7d32; --light-green: #4caf50; }
        body { background: #f4f7f6; font-size: 0.9rem; font-family: 'Segoe UI', sans-serif; }
        
        /* Header phong cách làm vườn */
        header { 
            background: linear-gradient(to right, var(--garden-green), var(--light-green));
            color: white; padding: 20px 0; border-bottom: 5px solid #1b5e20; margin-bottom: 25px;
        }
        
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-card { transition: transform 0.2s; border-bottom: 4px solid var(--garden-green); }
        .stat-card:hover { transform: translateY(-5px); }
        
        .money { text-align: right; font-family: 'Consolas', monospace; font-weight: bold; }
        .money-input { text-align: right; font-weight: bold; color: #1565c0; border: 1px solid #ddd; }
        
        .table-dark { background-color: var(--garden-green) !important; border: none; }
        .btn-garden { background-color: var(--garden-green); color: white; border: none; }
        .btn-garden:hover { background-color: #1b5e20; color: white; }
        
        .chart-container { height: 250px; position: relative; }
    </style>
</head>
<body>

<header class="text-center shadow">
    <h3 class="fw-bold mb-0"><i class="fas fa-seedling"></i> QUẢN LÝ CHI PHÍ LÀM VƯỜN SR2526</h3>
    <small>Hệ thống tự động cập nhật & Báo cáo qua Email</small>
</header>

<div class="container">
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card stat-card p-3 text-center">
                <small class="text-muted fw-bold text-uppercase">Tổng Chi Phí</small>
                <div class="h3 text-success fw-bold" id="tTotal">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card p-3 text-center" style="border-color: #0288d1;">
                <small class="text-muted fw-bold text-uppercase">Tiền Vật Tư</small>
                <div class="h3 text-info fw-bold" id="tVatTu">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card p-3 text-center" style="border-color: #fbc02d;">
                <small class="text-muted fw-bold text-uppercase">Tiền Công Thợ</small>
                <div class="h3 text-warning fw-bold" id="tTienCong">0</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-5">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">Tỷ lệ cơ cấu chi phí</h6>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">Tổng hợp lương nhân viên</h6>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="card p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-history text-success"></i> NHẬT KÝ CHI TIẾT</h6>
            <button class="btn btn-garden fw-bold shadow-sm" onclick="openAddModal()">
                <i class="fas fa-plus-circle"></i> THÊM MỚI
            </button>
        </div>
        <div class="table-responsive">
            <table id="mainTable" class="table table-hover w-100 border">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th><th>Ngày</th><th>Nội dung</th><th>Vật tư</th><th>Công</th><th>Xử lý</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h6 class="modal-title fw-bold" id="modalTitle">Nhập dữ liệu vườn</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="row g-2 mb-3">
                    <div class="col-md-4"><label class="small fw-bold">Ngày làm</label><input type="date" id="date" class="form-control"></div>
                    <div class="col-md-8"><label class="small fw-bold">Nội dung công việc</label><input id="content" class="form-control" placeholder="Ví dụ: Bón phân, cắt cỏ..."></div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-md-6"><label class="small fw-bold text-info">Tiền vật tư (VNĐ)</label><input id="vatTu" class="form-control money-input" value="0"></div>
                    <div class="col-md-6"><label class="small fw-bold text-warning">Tiền công thợ (VNĐ)</label><input id="tienCong" class="form-control money-input" value="0"></div>
                </div>
                <div class="p-3 border rounded bg-light mb-3">
                    <label class="small fw-bold text-success mb-2 d-block"><i class="fas fa-users"></i> PHÂN CHIA LƯƠNG NHÂN VIÊN:</label>
                    <div class="row g-2 text-center">
                        <div class="col-3"><small>Triều</small><input id="trieu" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><small>Tèo</small><input id="teo" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><small>Thiện</small><input id="thien" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><small>Thuận</small><input id="thuan" class="form-control form-control-sm money-input" value="0"></div>
                    </div>
                </div>
                <div class="mb-3"><label class="small fw-bold">Ghi chú (nếu có)</label><input id="note" class="form-control" placeholder="..."></div>
                
                <div id="loadingStatus" class="text-center d-none mb-2">
                    <div class="spinner-border spinner-border-sm text-success"></div> <small class="text-success">Đang xử lý & gửi email báo cáo...</small>
                </div>
                <button id="saveBtn" class="btn btn-success w-100 fw-bold py-2 shadow" onclick="handleSave()">LƯU DỮ LIỆU</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="authModal">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-body p-4 text-center">
                <i class="fas fa-lock fa-3x text-danger mb-3"></i>
                <h6 class="fw-bold">XÁC THỰC ADMIN</h6>
                <p class="small text-muted" id="authMsg"></p>
                <input type="password" id="adminPass" class="form-control text-center mb-3" placeholder="Mật khẩu">
                <div class="d-grid gap-2">
                    <button class="btn btn-danger fw-bold shadow-sm" onclick="processAuth()">XÁC NHẬN</button>
                    <button class="btn btn-light btn-sm" data-bs-dismiss="modal">Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    let rawData = [], actionType = '', selectedId = '', pendingData = {};
    let pieChart, barChart;

    const formatVN = n => Number(n).toLocaleString("vi-VN");
    const parseVN = v => Number(String(v).replace(/[^0-9-]/g, "")) || 0;

    $(document).ready(() => {
        // Tự động định dạng tiền tệ khi gõ
        $(document).on('focus', '.money-input', function() { let v = parseVN($(this).val()); $(this).val(v === 0 ? '' : v); });
        $(document).on('blur', '.money-input', function() { $(this).val(formatVN(parseVN($(this).val()))); });
        refreshAll();
    });

    function refreshAll() {
        // Tải bảng dữ liệu
        google.script.run.withSuccessHandler(data => {
            rawData = data;
            if ($.fn.DataTable.isDataTable('#mainTable')) $('#mainTable').DataTable().destroy();
            let html = '';
            data.forEach(r => {
                html += `<tr>
                    <td class="text-center text-muted small">${r[0]}</td>
                    <td class="fw-bold">${r[1]}</td>
                    <td>${r[2]}</td>
                    <td class="money text-info">${formatVN(r[3])}</td>
                    <td class="money text-warning">${formatVN(r[4])}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-warning border-0" onclick="openEdit(${r[0]})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="askDelete(${r[0]})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
            });
            $('#mainTable tbody').html(html);
            $('#mainTable').DataTable({ order: [[0,"desc"]], pageLength: 10, language: {url:"//cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json"} });
        }).getAllData();

        // Tải Thống kê & Biểu đồ cấu phí
        google.script.run.withSuccessHandler(s => {
            $('#tTotal').text(formatVN(s.total) + 'đ');
            $('#tVatTu').text(formatVN(s.vatTu) + 'đ');
            $('#tTienCong').text(formatVN(s.tienCong) + 'đ');
            drawPie(s.vatTu, s.tienCong);
        }).getSummaryData();

        // Tải Lương nhân viên & Biểu đồ cột
        google.script.run.withSuccessHandler(s => {
            drawBar(s);
        }).getStaffSummaryData();
    }

    function drawPie(v, t) {
        const ctx = document.getElementById('pieChart');
        if(pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Vật tư', 'Tiền công'], datasets: [{ data: [v, t], backgroundColor: ['#0288d1', '#fbc02d'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function drawBar(s) {
        const ctx = document.getElementById('barChart');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Triều', 'Tèo', 'Thiện', 'Thuận'], datasets: [{ label: 'VNĐ', data: [s.trieu, s.teo, s.thien, s.thuan], backgroundColor: '#4caf50' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function openAddModal() {
        $('#editId').val('');
        $('#date').val(new Date().toISOString().split('T')[0]);
        $('#content, #note').val('');
        $('.money-input').val('0');
        $('#modalTitle').text('THÊM MỚI CHI PHÍ VƯỜN');
        $('#saveBtn').text('LƯU DỮ LIỆU').removeClass('btn-warning').addClass('btn-success').prop('disabled', false);
        $('#loadingStatus').addClass('d-none');
        new bootstrap.Modal('#dataModal').show();
    }

    function openEdit(id) {
        const r = rawData.find(x => x[0] == id);
        if(!r) return;
        $('#editId').val(id);
        let dParts = r[1].split('/'); $('#date').val(`${dParts[2]}-${dParts[1]}-${dParts[0]}`);
        $('#content').val(r[2]); $('#vatTu').val(formatVN(r[3])); $('#tienCong').val(formatVN(r[4]));
        $('#note').val(r[5]); $('#trieu').val(formatVN(r[6])); $('#teo').val(formatVN(r[7]));
        $('#thien').val(formatVN(r[8])); $('#thuan').val(formatVN(r[9]));
        $('#modalTitle').text('CHỈNH SỬA ID #' + id);
        $('#saveBtn').text('CẬP NHẬT (CẦN MẬT KHẨU)').removeClass('btn-success').addClass('btn-warning').prop('disabled', false);
        $('#loadingStatus').addClass('d-none');
        new bootstrap.Modal('#dataModal').show();
    }

    function handleSave() {
        const id = $('#editId').val();
        const data = {
            date: $('#date').val().split('-').reverse().join('/'),
            content: $('#content').val().trim(),
            vatTu: parseVN($('#vatTu').val()),
            tienCong: parseVN($('#tienCong').val()),
            note: $('#note').val(),
            trieu: parseVN($('#trieu').val()), teo: parseVN($('#teo').val()),
            thien: parseVN($('#thien').val()), thuan: parseVN($('#thuan').val())
        };

        if(!data.content) return alert("Vui lòng nhập nội dung công việc!");

        if(id) {
            pendingData = data; selectedId = id; actionType = 'edit';
            $('#authMsg').text('Xác nhận cập nhật bản ghi #' + id);
            bootstrap.Modal.getInstance('#dataModal').hide();
            new bootstrap.Modal('#authModal').show();
        } else {
            $('#saveBtn').prop('disabled', true).text('Đang lưu...');
            $('#loadingStatus').removeClass('d-none');
            google.script.run.withSuccessHandler(res => {
                alert(res.message); refreshAll(); bootstrap.Modal.getInstance('#dataModal').hide();
            }).saveNewEntryFromClient(data);
        }
    }

    function askDelete(id) {
        selectedId = id; actionType = 'delete';
        $('#authMsg').text('Hành động xóa bản ghi #' + id + ' không thể hoàn tác!');
        new bootstrap.Modal('#authModal').show();
    }

    function processAuth() {
        const p = $('#adminPass').val();
        if(!p) return alert("Nhập mật khẩu!");
        
        const callback = (res) => {
            if(res.status === 'success') {
                alert(res.message); bootstrap.Modal.getInstance('#authModal').hide();
                $('#adminPass').val(''); refreshAll();
            } else alert(res.message);
        };

        if(actionType === 'edit') google.script.run.withSuccessHandler(callback).performUpdate(selectedId, pendingData, 'Admin', p);
        else google.script.run.withSuccessHandler(callback).performDelete(selectedId, 'Admin', p);
    }
</script>
</body>
</html>
