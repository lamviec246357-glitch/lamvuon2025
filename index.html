// ============================
// H√ÄM XU·∫§T PDF CHUY√äN NGHI·ªÜP (ƒê√É S·ª¨A L·ªñI)
// ============================

async function exportSummaryReport() {
    try {
        if (!currentRows || currentRows.length === 0) {
            alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
            return;
        }
        
        showExportProgress();
        updateExportProgress(10, 'ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...');
        
        // L·∫•y d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n
        let totalVatTu = 0, totalTienCong = 0, totalAll = 0;
        let dataCount = 0;
        
        for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
            const row = currentRows[i];
            if (row && row.length >= 5) {
                dataCount++;
                totalVatTu += parseSheetNumber(row[3]);
                totalTienCong += parseSheetNumber(row[4]);
            }
        }
        
        totalAll = totalVatTu + totalTienCong;
        
        updateExportProgress(30, 'ƒêang t·∫°o n·ªôi dung b√°o c√°o...');
        
        const now = new Date();
        const formattedDate = now.toLocaleDateString('vi-VN');
        const formattedTime = now.toLocaleTimeString('vi-VN');
        
        // T·∫°o m·ªôt div t·∫°m ƒë·ªÉ ch·ª©a n·ªôi dung PDF
        const pdfContainer = document.createElement('div');
        pdfContainer.id = 'pdf-temp-container';
        pdfContainer.style.cssText = `
            position: fixed;
            left: 0;
            top: 0;
            width: 800px;
            min-height: 1123px; /* A4 height */
            background: white;
            padding: 40px;
            font-family: 'Arial', 'DejaVu Sans', sans-serif;
            color: #000;
            z-index: 9999;
            transform: translateX(-100%);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        `;
        
        // T·∫°o n·ªôi dung HTML cho PDF
        pdfContainer.innerHTML = `
            <div id="pdf-content" style="font-family: 'Arial', 'DejaVu Sans', sans-serif;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px;">
                    <h1 style="color: #2e7d32; font-size: 24px; margin-bottom: 10px; font-weight: bold;">B√ÅO C√ÅO CHI PH√ç L√ÄM V∆Ø·ªúN</h1>
                    <p style="font-size: 14px; color: #666;">H·ªá th·ªëng qu·∫£n l√Ω v√† theo d√µi chi ph√≠ t·ª± ƒë·ªông c·∫≠p nh·∫≠t</p>
                    <p style="font-size: 12px; color: #888;">Ng√†y xu·∫•t: ${formattedDate} ${formattedTime}</p>
                </div>
                
                <!-- Th√¥ng tin h·ªá th·ªëng -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                    <h2 style="color: #2e7d32; font-size: 16px; margin-bottom: 15px; font-weight: bold;">üìä TH√îNG TIN H·ªÜ TH·ªêNG</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd; width: 40%;"><strong>T·ªïng s·ªë h·∫°ng m·ª•c:</strong></td>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;">${dataCount}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;"><strong>T·ªïng chi ph√≠:</strong></td>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd; color: #d32f2f; font-weight: bold;">${formatCurrency(totalAll)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;"><strong>Ph√≠ v·∫≠t t∆∞:</strong></td>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;">${formatCurrency(totalVatTu)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;"><strong>Ti·ªÅn c√¥ng:</strong></td>
                            <td style="padding: 10px 0; border-bottom: 1px solid #ddd;">${formatCurrency(totalTienCong)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 0;"><strong>L·∫ßn c·∫≠p nh·∫≠t cu·ªëi:</strong></td>
                            <td style="padding: 10px 0;">${lastUpdateTime ? lastUpdateTime.toLocaleString('vi-VN') : 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                        </tr>
                    </table>
                </div>
                
                <!-- Ph√¢n b·ªï chi ph√≠ -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #2e7d32; font-size: 16px; margin-bottom: 15px; font-weight: bold;">üìà PH√ÇN B·ªî CHI PH√ç</h2>
                    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f0f7ff; border-radius: 8px; width: 45%; border: 1px solid #2196F3;">
                            <div style="font-size: 20px; color: #4CAF50; font-weight: bold;">${formatCurrency(totalVatTu)}</div>
                            <div style="font-size: 14px; color: #666;">Ph√≠ v·∫≠t t∆∞</div>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">${((totalVatTu / totalAll) * 100).toFixed(1)}%</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fff0f0; border-radius: 8px; width: 45%; border: 1px solid #f44336;">
                            <div style="font-size: 20px; color: #2196F3; font-weight: bold;">${formatCurrency(totalTienCong)}</div>
                            <div style="font-size: 14px; color: #666;">Ti·ªÅn c√¥ng</div>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">${((totalTienCong / totalAll) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
                
                <!-- B·∫£ng d·ªØ li·ªáu m·∫´u -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #2e7d32; font-size: 16px; margin-bottom: 15px; font-weight: bold;">üìã D·ªÆ LI·ªÜU M·∫™U (10 H√ÄNG ƒê·∫¶U)</h2>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 12px;">
                        <thead>
                            <tr style="background: #2e7d32; color: white;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">STT</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Ng√†y</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">N·ªôi dung</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Ph√≠ v·∫≠t t∆∞</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Ti·ªÅn c√¥ng</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">T·ªïng</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // Th√™m d·ªØ li·ªáu m·∫´u
        const sampleCount = Math.min(10, dataCount);
        let sampleDataHTML = '';
        for (let i = 0; i < sampleCount; i++) {
            const rowIndex = START_ROW - 1 + i;
            if (rowIndex < currentRows.length) {
                const row = currentRows[rowIndex];
                if (row && row.length >= 5) {
                    const vatTu = parseSheetNumber(row[3]);
                    const tienCong = parseSheetNumber(row[4]);
                    const total = vatTu + tienCong;
                    
                    sampleDataHTML += `
                        <tr style="${i % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${i + 1}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${row[1] || ''}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${(row[2] || '').substring(0, 40)}${(row[2] || '').length > 40 ? '...' : ''}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(vatTu)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(tienCong)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatCurrency(total)}</td>
                        </tr>
                    `;
                }
            }
        }
        
        pdfContainer.innerHTML += sampleDataHTML;
        pdfContainer.innerHTML += `
                        </tbody>
                    </table>
                    <p style="font-size: 11px; color: #666; margin-top: 10px; text-align: center;">
                        Hi·ªÉn th·ªã ${sampleCount} trong t·ªïng s·ªë ${dataCount} h·∫°ng m·ª•c
                    </p>
                </div>
                
                <!-- Ph√¢n t√≠ch chi ti·∫øt -->
                <div style="margin-bottom: 30px; padding: 20px; background: #fff8e1; border-radius: 8px; border: 1px solid #ffd54f;">
                    <h2 style="color: #2e7d32; font-size: 16px; margin-bottom: 15px; font-weight: bold;">üìä PH√ÇN T√çCH CHI TI·∫æT</h2>
                    <div style="font-size: 13px;">
                        <p>‚Ä¢ <strong>T·ª∑ l·ªá ph√¢n b·ªï:</strong> Ph√≠ v·∫≠t t∆∞ chi·∫øm ${((totalVatTu / totalAll) * 100).toFixed(1)}%, Ti·ªÅn c√¥ng chi·∫øm ${((totalTienCong / totalAll) * 100).toFixed(1)}% t·ªïng chi ph√≠.</p>
                        <p>‚Ä¢ <strong>Chi ph√≠ trung b√¨nh:</strong> ${formatCurrency(totalAll / dataCount)}/h·∫°ng m·ª•c.</p>
                        <p>‚Ä¢ <strong>Th·ªùi gian c·∫≠p nh·∫≠t:</strong> H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 3 ph√∫t.</p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 11px;">
                    <p>H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn &copy; ${new Date().getFullYear()}</p>
                    <p style="margin-top: 5px;">Google Sheet: ${SHEET_ID} | Sheet: ${SHEET_NAME}</p>
                    <p style="margin-top: 5px;">B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông - Trang 1/1</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(pdfContainer);
        
        updateExportProgress(50, 'ƒêang t·∫°o PDF...');
        
        // Ch·ªù DOM render xong
        setTimeout(() => {
            // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p n·ªôi dung
            html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                allowTaint: true,
                removeContainer: true
            }).then(canvas => {
                updateExportProgress(80, 'ƒêang x·ª≠ l√Ω h√¨nh ·∫£nh...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Th√™m h√¨nh ·∫£nh v√†o PDF
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgWidth = 190; // mm cho A4 (210mm - margin 20mm)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Ki·ªÉm tra chi·ªÅu cao
                let yPosition = 10;
                let remainingHeight = imgHeight;
                const pageHeight = 277; // Chi·ªÅu cao A4 tr·ª´ margin
                
                while (remainingHeight > 0) {
                    doc.addImage(imgData, 'JPEG', 10, yPosition, imgWidth, imgHeight);
                    remainingHeight -= pageHeight;
                    yPosition -= pageHeight;
                    
                    if (remainingHeight > 0) {
                        doc.addPage();
                    }
                }
                
                updateExportProgress(95, 'ƒêang l∆∞u file...');
                
                // L∆∞u file
                const fileName = `Bao_cao_chi_phi_lam_vuon_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.pdf`;
                doc.save(fileName);
                
                // D·ªçn d·∫πp
                document.body.removeChild(pdfContainer);
                
                updateExportProgress(100, 'Xu·∫•t PDF th√†nh c√¥ng!');
                setTimeout(hideExportProgress, 1000);
                
            }).catch(error => {
                console.error('L·ªói khi t·∫°o canvas:', error);
                // Fallback: t·∫°o PDF c∆° b·∫£n n·∫øu html2canvas fail
                createBasicPDF();
                document.body.removeChild(pdfContainer);
            });
            
        }, 500);
        
    } catch (error) {
        console.error('L·ªói khi xu·∫•t PDF:', error);
        alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t PDF: ' + error.message);
        hideExportProgress();
        
        // X√≥a container n·∫øu t·ªìn t·∫°i
        const existingContainer = document.getElementById('pdf-temp-container');
        if (existingContainer) {
            document.body.removeChild(existingContainer);
        }
    }
}

// H√†m t·∫°o PDF c∆° b·∫£n (fallback - kh√¥ng d√πng bi·ªÉu ƒë·ªì)
function createBasicPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // T√≠nh t·ªïng
    let totalVatTu = 0, totalTienCong = 0, totalAll = 0;
    let dataCount = 0;
    
    for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
        const row = currentRows[i];
        if (row && row.length >= 5) {
            dataCount++;
            totalVatTu += parseSheetNumber(row[3]);
            totalTienCong += parseSheetNumber(row[4]);
        }
    }
    
    totalAll = totalVatTu + totalTienCong;
    const now = new Date();
    
    // Ti√™u ƒë·ªÅ
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('B√ÅO C√ÅO CHI PH√ç L√ÄM V∆Ø·ªúN', 105, 15, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Ng√†y xu·∫•t: ${now.toLocaleDateString('vi-VN')} ${now.toLocaleTimeString('vi-VN')}`, 105, 22, { align: 'center' });
    
    // Th√¥ng tin t·ªïng quan
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('TH√îNG TIN T·ªîNG QUAN', 20, 35);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`T·ªïng s·ªë h·∫°ng m·ª•c: ${dataCount}`, 20, 45);
    doc.text(`T·ªïng chi ph√≠: ${formatCurrency(totalAll)}`, 20, 52);
    doc.text(`Ph√≠ v·∫≠t t∆∞: ${formatCurrency(totalVatTu)} (${((totalVatTu / totalAll) * 100).toFixed(1)}%)`, 20, 59);
    doc.text(`Ti·ªÅn c√¥ng: ${formatCurrency(totalTienCong)} (${((totalTienCong / totalAll) * 100).toFixed(1)}%)`, 20, 66);
    
    // T·∫°o bi·ªÉu ƒë·ªì ƒë∆°n gi·∫£n b·∫±ng h√¨nh ch·ªØ nh·∫≠t
    doc.setDrawColor(76, 175, 80);
    doc.setFillColor(76, 175, 80);
    doc.rect(20, 75, 80, 15, 'F');
    
    doc.setDrawColor(33, 150, 243);
    doc.setFillColor(33, 150, 243);
    doc.rect(20, 95, (totalTienCong / totalAll) * 80, 15, 'F');
    
    doc.setFontSize(9);
    doc.text('Ph√≠ v·∫≠t t∆∞', 25, 85);
    doc.text('Ti·ªÅn c√¥ng', 25, 105);
    
    // D·ªØ li·ªáu m·∫´u
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('D·ªÆ LI·ªÜU M·∫™U', 20, 125);
    
    let yPos = 135;
    const sampleCount = Math.min(5, dataCount);
    
    for (let i = 0; i < sampleCount && yPos < 280; i++) {
        const rowIndex = START_ROW - 1 + i;
        if (rowIndex < currentRows.length) {
            const row = currentRows[rowIndex];
            if (row && row.length >= 5) {
                const content = (row[2] || '').substring(0, 40);
                const total = parseSheetNumber(row[3]) + parseSheetNumber(row[4]);
                
                doc.setFontSize(9);
                doc.text(`${i+1}. ${content}`, 25, yPos);
                doc.text(formatCurrency(total), 160, yPos);
                
                yPos += 7;
            }
        }
    }
    
    // Footer
    doc.setFontSize(8);
    doc.text(`Hi·ªÉn th·ªã ${sampleCount} trong t·ªïng s·ªë ${dataCount} h·∫°ng m·ª•c`, 105, yPos + 10, { align: 'center' });
    doc.text(`H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn ¬© ${now.getFullYear()}`, 105, 290, { align: 'center' });
    
    // L∆∞u file
    const fileName = `Bao_cao_chi_phi_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.pdf`;
    doc.save(fileName);
}
