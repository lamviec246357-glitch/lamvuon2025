<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Lý SR2526 - Dashboard Hoàn Chỉnh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-size: 0.9rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: 0.3s; }
        .card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.12); }
        .money { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; }
        .money-input { text-align: right; font-weight: bold; color: #0d6efd; }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        .stat-label { font-size: 0.75rem; color: #6c757d; font-weight: bold; text-transform: uppercase; }
        .table thead { background-color: #212529; color: white; }
        .action-btn { padding: 2px 8px; border-radius: 6px; }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card p-3 text-center border-start border-primary border-4">
                <div class="stat-label">TỔNG CHI PHÍ</div>
                <div class="h4 text-primary fw-bold mb-0" id="tTotal">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center border-start border-info border-4">
                <div class="stat-label">TIỀN VẬT TƯ</div>
                <div class="h4 text-info fw-bold mb-0" id="tVatTu">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center border-start border-warning border-4">
                <div class="stat-label">TIỀN CÔNG</div>
                <div class="h4 text-warning fw-bold mb-0" id="tTienCong">0</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-5">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">TỶ LỆ CHI PHÍ</h6>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">LƯƠNG NHÂN VIÊN TÍCH LŨY</h6>
                <div class="chart-wrapper">
                    <canvas id="staffChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-list-alt text-primary"></i> NHẬT KÝ CHI PHÍ</h6>
            <button class="btn btn-success btn-sm fw-bold px-3 shadow-sm" onclick="openModal('add')">
                <i class="fas fa-plus-circle"></i> THÊM MỚI
            </button>
        </div>
        <div class="table-responsive">
            <table id="tbl" class="table table-sm table-hover w-100 border">
                <thead>
                    <tr>
                        <th class="text-center">ID</th>
                        <th>Ngày</th>
                        <th>Nội dung</th>
                        <th class="text-end">Vật tư</th>
                        <th class="text-end">Công</th>
                        <th class="text-center">Xử lý</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modal" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white p-2 px-3">
                <h6 class="modal-title" id="mTitle">Nhập liệu</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="row g-2 mb-2">
                    <div class="col-4"><label class="small fw-bold">Ngày (*)</label><input type="date" id="date" class="form-control form-control-sm"></div>
                    <div class="col-8"><label class="small fw-bold">Nội dung công việc (*)</label><input id="content" class="form-control form-control-sm" placeholder="Ví dụ: Mua sơn, trả lương tuần..."></div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold text-info">Tiền Vật tư</label><input id="vatTu" class="form-control form-control-sm money-input" value="0"></div>
                    <div class="col-6"><label class="small fw-bold text-warning">Tiền công thợ</label><input id="tienCong" class="form-control form-control-sm money-input" value="0"></div>
                </div>
                <div class="p-2 border rounded bg-light mb-2">
                    <small class="text-muted fw-bold d-block mb-2"><i class="fas fa-users"></i> CHI TIẾT CHIA LƯƠNG:</small>
                    <div class="row g-1 text-center">
                        <div class="col-3"><label class="small">Triều</label><input id="trieu" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">Tèo</label><input id="teo" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">Thiện</label><input id="thien" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">Thuận</label><input id="thuan" class="form-control form-control-sm money-input" value="0"></div>
                    </div>
                </div>
                <div class="mb-3"><label class="small fw-bold">Ghi chú thêm</label><input id="note" class="form-control form-control-sm"></div>
                
                <div id="saveLoading" class="text-center d-none mb-2">
                    <div class="spinner-border spinner-border-sm text-primary"></div> <small class="text-primary">Đang lưu và gửi email thông báo...</small>
                </div>
                <button id="saveBtn" class="btn btn-primary w-100 fw-bold py-2 shadow-sm" onclick="save()">LƯU THÔNG TIN</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-danger"><i class="fas fa-user-shield fa-3x"></i></div>
                <h6 class="fw-bold mb-1">XÁC THỰC QUẢN TRỊ</h6>
                <p class="small text-muted mb-3" id="authTxt"></p>
                <input type="password" id="authPass" class="form-control text-center mb-3" placeholder="Nhập mật khẩu...">
                <div id="authLoading" class="spinner-border spinner-border-sm text-primary d-none mb-2"></div>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger fw-bold" onclick="confirmAuth()">XÁC NHẬN</button>
                    <button class="btn btn-light btn-sm" data-bs-dismiss="modal">Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    let currentData = [], currentAction = '', targetId = '', tempSave = {};
    let costChart, staffChart;
    
    const money = n => Number(n).toLocaleString("vi-VN");
    const unMoney = v => Number(String(v).replace(/[^0-9-]/g, "")) || 0;

    $(document).ready(() => {
        // Tự động định dạng tiền khi nhập
        $(document).on('focus', '.money-input', function() { 
            let v = unMoney($(this).val()); 
            $(this).val(v === 0 ? '' : v); 
        });
        $(document).on('blur', '.money-input', function() { 
            $(this).val(money(unMoney($(this).val()))); 
        });
        load();
    });

    // Hàm tải dữ liệu tổng thể
    function load() {
        // Tải bảng
        google.script.run.withSuccessHandler(d => {
            currentData = d;
            if ($.fn.DataTable.isDataTable('#tbl')) $('#tbl').DataTable().destroy();
            let h = '';
            d.forEach(r => {
                h += `<tr>
                    <td class="text-center text-muted small">${r[0]}</td>
                    <td class="fw-bold text-nowrap">${r[1]}</td>
                    <td>${r[2]}</td>
                    <td class="money text-info">${money(r[3])}</td>
                    <td class="money text-warning">${money(r[4])}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-warning border-0 action-btn" onclick="openEdit(${r[0]})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0 action-btn" onclick="askDelete(${r[0]})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            $('#tbl tbody').html(h);
            $('#tbl').DataTable({ 
                order: [[0, "desc"]], 
                pageLength: 8, 
                language: { url: "//cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json" } 
            });
        }).getAllData();

        // Tải biểu đồ tròn & Thống kê
        google.script.run.withSuccessHandler(s => {
            $('#tTotal').text(money(s.total) + 'đ');
            $('#tVatTu').text(money(s.vatTu) + 'đ');
            $('#tTienCong').text(money(s.tienCong) + 'đ');
            renderCostChart(s.vatTu, s.tienCong);
        }).getSummaryData();

        // Tải biểu đồ cột lương
        google.script.run.withSuccessHandler(s => {
            renderStaffChart(s);
        }).getStaffSummaryData();
    }

    function renderCostChart(v, t) {
        const ctx = document.getElementById('costChart');
        if(costChart) costChart.destroy();
        costChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Vật tư', 'Tiền công'],
                datasets: [{ data: [v, t], backgroundColor: ['#0dcaf0', '#ffc107'], hoverOffset: 12 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderStaffChart(s) {
        const ctx = document.getElementById('staffChart');
        if(staffChart) staffChart.destroy();
        staffChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Triều', 'Tèo', 'Thiện', 'Thuận'],
                datasets: [{
                    label: 'Tổng tiền (đ)',
                    data: [s.trieu, s.teo, s.thien, s.thuan],
                    backgroundColor: '#0d6efd',
                    borderRadius: 6
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function openModal(mode) {
        $('#editId').val('');
        $('#date').val(new Date().toISOString().split('T')[0]);
        $('#content').val(''); $('#note').val('');
        $('.money-input').val('0');
        $('#mTitle').text('THÊM MỚI CHI PHÍ');
        $('#saveBtn').text('LƯU DỮ LIỆU').removeClass('btn-warning').addClass('btn-primary').prop('disabled', false);
        $('#saveLoading').addClass('d-none');
        new bootstrap.Modal('#modal').show();
    }

    function openEdit(id) {
        const r = currentData.find(x => x[0] == id);
        if(!r) return;
        $('#editId').val(id);
        let dt = r[1].split('/'); 
        $('#date').val(`${dt[2]}-${dt[1]}-${dt[0]}`);
        $('#content').val(r[2]); 
        $('#vatTu').val(money(r[3])); $('#tienCong').val(money(r[4]));
        $('#note').val(r[5]); 
        $('#trieu').val(money(r[6])); $('#teo').val(money(r[7]));
        $('#thien').val(money(r[8])); $('#thuan').val(money(r[9]));
        $('#mTitle').text('CHỈNH SỬA BẢN GHI #' + id);
        $('#saveBtn').text('CẬP NHẬT (CẦN PASS)').removeClass('btn-primary').addClass('btn-warning').prop('disabled', false);
        $('#saveLoading').addClass('d-none');
        new bootstrap.Modal('#modal').show();
    }

    function save() {
        const id = $('#editId').val();
        const data = {
            date: $('#date').val().split('-').reverse().join('/'),
            content: $('#content').val().trim(),
            vatTu: unMoney($('#vatTu').val()),
            tienCong: unMoney($('#tienCong').val()),
            note: $('#note').val(),
            trieu: unMoney($('#trieu').val()), teo: unMoney($('#teo').val()),
            thien: unMoney($('#thien').val()), thuan: unMoney($('#thuan').val())
        };
        
        if(!data.content || !data.date) return alert("Vui lòng nhập Ngày và Nội dung!");

        if(id) {
            // Trường hợp cập nhật
            tempSave = data; targetId = id; currentAction = 'edit';
            $('#authTxt').text('Bạn đang thay đổi dữ liệu của ID #' + id);
            bootstrap.Modal.getInstance('#modal').hide();
            new bootstrap.Modal('#loginModal').show();
        } else {
            // Trường hợp thêm mới (Gửi mail luôn)
            $('#saveBtn').prop('disabled', true).text('Đang xử lý...');
            $('#saveLoading').removeClass('d-none');
            
            google.script.run.withSuccessHandler((res) => { 
                alert(res.message); 
                load(); 
                bootstrap.Modal.getInstance('#modal').hide(); 
            }).saveNewEntryFromClient(data);
        }
    }

    function askDelete(id) {
        targetId = id; currentAction = 'delete';
        $('#authTxt').text('Hành động xóa ID #' + id + ' sẽ gửi mail báo cáo và không thể hoàn tác!');
        new bootstrap.Modal('#loginModal').show();
    }

    function confirmAuth() {
        const p = $('#authPass').val();
        if(!p) return alert("Vui lòng nhập mật khẩu!");
        
        $('#authLoading').removeClass('d-none');
        const handleRes = (res) => {
            $('#authLoading').addClass('d-none');
            if(res.status === 'success') {
                alert(res.message);
                bootstrap.Modal.getInstance('#loginModal').hide();
                $('#authPass').val('');
                load();
            } else alert(res.message);
        };

        if(currentAction === 'edit') {
            google.script.run.withSuccessHandler(handleRes).performUpdate(targetId, tempSave, 'Admin', p);
        } else {
            google.script.run.withSuccessHandler(handleRes).performDelete(targetId, 'Admin', p);
        }
    }
</script>
</body>
</html>
