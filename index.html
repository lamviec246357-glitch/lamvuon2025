<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ph√≠ l√†m v∆∞·ªùn - Qu·∫£n l√Ω th√¥ng minh</title>
    <!-- Chart.js cho bi·ªÉu ƒë·ªì -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS cho xu·∫•t Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF cho xu·∫•t PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- EmailJS cho g·ª≠i email -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        header {
            text-align: center;
            margin-bottom: 45px;
            padding-bottom: 30px;
            border-bottom: 4px solid #4CAF50;
            position: relative;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 25%;
            width: 50%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #4CAF50, transparent);
        }
        
        h1 {
            color: #2d5c2a;
            margin-bottom: 10px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #2d5c2a, #4CAF50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(106, 17, 203, 0.6);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }
        
        .card {
            background: linear-gradient(145deg, #ffffff, #f8fff8);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid #4CAF50;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .card:hover {
            transform: translateY(-15px) scale(1.03);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        /* Search and Filter */
        .search-filter-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        
        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .filter-btn {
            padding: 12px 25px;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: #4CAF50;
            color: white;
        }
        
        /* Export Section */
        .export-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 20px;
            padding: 30px;
            margin: 40px 0;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 18px 35px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.4);
        }
        
        .export-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(33, 150, 243, 0.6);
        }
        
        .export-btn.pdf {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            box-shadow: 0 6px 15px rgba(244, 67, 54, 0.4);
        }
        
        .export-btn.excel {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }
        
        /* Email Notification */
        .email-section {
            background: linear-gradient(135deg, #fff3e0, #ffecb3);
            border-radius: 20px;
            padding: 30px;
            margin: 40px 0;
        }
        
        .email-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .email-input {
            padding: 15px 20px;
            border: 2px solid #FF9800;
            border-radius: 12px;
            font-size: 1.1em;
        }
        
        .email-btn {
            padding: 18px;
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .email-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }
        
        /* Table Styling */
        .data-table-container {
            overflow-x: auto;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            border-bottom: 1px solid #eee;
            padding: 18px 15px;
            text-align: left;
        }
        
        tr:hover {
            background-color: #f5f9f5;
            transition: background-color 0.2s;
        }
        
        /* System Info */
        .system-info {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #4CAF50;
        }
        
        /* Footer */
        footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid #eee;
            color: #666;
            font-size: 0.95em;
        }
        
        /* Loading Animation */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-style: italic;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 400px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                min-width: 100%;
            }
            
            .tab-btn {
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2em;
            }
        }
        
        .update-info {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .update-item {
            margin: 10px;
        }
        
        .update-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåø CHI PH√ç L√ÄM V∆Ø·ªúN - QU·∫¢N L√ù TH√îNG MINH</h1>
            <p class="subtitle">H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn v·ªõi bi·ªÉu ƒë·ªì tr·ª±c quan v√† t·ª± ƒë·ªông h√≥a</p>
            
            <div class="update-info">
                <div class="update-item">
                    <div>‚è∞ T·ª± ƒë·ªông c·∫≠p nh·∫≠t</div>
                    <div class="update-value" id="nextUpdate">3:00</div>
                    <div>ph√∫t n·ªØa</div>
                </div>
                <div class="update-item">
                    <div>üìä S·ªë h√†ng d·ªØ li·ªáu</div>
                    <div class="update-value" id="totalRows">0</div>
                    <div>h√†ng</div>
                </div>
                <div class="update-item">
                    <div>üìß Email th√¥ng b√°o</div>
                    <div class="update-value">‚úÖ</div>
                    <div>phongvumobie79@gmail.com</div>
                </div>
            </div>
        </header>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">
                <span>üìä</span> T·ªïng quan
            </button>
            <button class="tab-btn" onclick="switchTab('charts')">
                <span>üìà</span> Bi·ªÉu ƒë·ªì
            </button>
            <button class="tab-btn" onclick="switchTab('search')">
                <span>üîç</span> T√¨m ki·∫øm
            </button>
            <button class="tab-btn" onclick="switchTab('export')">
                <span>üíæ</span> Xu·∫•t file
            </button>
            <button class="tab-btn" onclick="switchTab('email')">
                <span>üìß</span> Th√¥ng b√°o
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div id="summary" class="summary-grid">
                <!-- Cards will be populated by JavaScript -->
            </div>
            
            <div class="data-table-container">
                <h2 style="color: #2d5c2a; margin-bottom: 20px; text-align: center;">üìã Chi ti·∫øt d·ªØ li·ªáu</h2>
                <div class="loading" id="tableLoading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                <div id="detailContent"></div>
            </div>
        </div>
        
        <!-- Charts Tab -->
        <div id="charts-tab" class="tab-content">
            <div class="charts-container">
                <div class="chart-card">
                    <h3 style="color: #2d5c2a; margin-bottom: 20px;">üìä Ph√¢n b·ªï chi ph√≠</h3>
                    <canvas id="costDistributionChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 style="color: #2d5c2a; margin-bottom: 20px;">üìà Chi ph√≠ theo th√°ng</h3>
                    <canvas id="monthlyCostChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 style="color: #2d5c2a; margin-bottom: 20px;">üë® Ph√¢n b·ªï ti·ªÅn c√¥ng</h3>
                    <canvas id="personCostChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 style="color: #2d5c2a; margin-bottom: 20px;">üìä So s√°nh ph√≠ v·∫≠t t∆∞ vs ti·ªÅn c√¥ng</h3>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Search Tab -->
        <div id="search-tab" class="tab-content">
            <div class="search-filter-container">
                <h2 style="color: #2d5c2a; margin-bottom: 25px;">üîç T√¨m ki·∫øm & L·ªçc d·ªØ li·ªáu</h2>
                
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="T√¨m ki·∫øm theo n·ªôi dung, ID, ng√†y...">
                    <input type="number" id="minAmount" class="search-input" placeholder="S·ªë ti·ªÅn t·ªëi thi·ªÉu">
                    <input type="number" id="maxAmount" class="search-input" placeholder="S·ªë ti·ªÅn t·ªëi ƒëa">
                    <input type="date" id="dateFrom" class="search-input">
                    <input type="date" id="dateTo" class="search-input">
                    <button onclick="performSearch()" class="filter-btn active" style="background: #4CAF50; color: white;">
                        üîç T√¨m ki·∫øm
                    </button>
                    <button onclick="resetSearch()" class="filter-btn">
                        ‚Üª ƒê·∫∑t l·∫°i
                    </button>
                </div>
                
                <div class="filter-options">
                    <button class="filter-btn" onclick="filterByColumn('vatTu')">üõ†Ô∏è Ph√≠ v·∫≠t t∆∞</button>
                    <button class="filter-btn" onclick="filterByColumn('tienCong')">üë∑ Ti·ªÅn c√¥ng</button>
                    <button class="filter-btn" onclick="filterByColumn('trieu')">üë® Tri·ªÅu</button>
                    <button class="filter-btn" onclick="filterByColumn('teo')">üë® T√®o</button>
                    <button class="filter-btn" onclick="filterByColumn('thien')">üë® Thi·ªán</button>
                    <button class="filter-btn" onclick="filterByColumn('thuan')">üë® Thu·∫≠n</button>
                    <button class="filter-btn" onclick="sortByDate()">üìÖ S·∫Øp x·∫øp theo ng√†y</button>
                    <button class="filter-btn" onclick="sortByAmount()">üí∞ S·∫Øp x·∫øp theo s·ªë ti·ªÅn</button>
                </div>
                
                <div id="searchResults" style="margin-top: 30px;">
                    <div class="loading" id="searchLoading">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...</div>
                </div>
            </div>
        </div>
        
        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
            <div class="export-section">
                <h2 style="color: #2d5c2a; margin-bottom: 20px;">üíæ Xu·∫•t d·ªØ li·ªáu ra file</h2>
                <p style="color: #666; margin-bottom: 25px; font-size: 1.1em;">
                    Xu·∫•t to√†n b·ªô d·ªØ li·ªáu chi ph√≠ l√†m v∆∞·ªùn ra file Excel ho·∫∑c PDF
                </p>
                
                <div class="export-buttons">
                    <button class="export-btn excel" onclick="exportToExcel()">
                        <span>üìó</span> Xu·∫•t Excel (.xlsx)
                    </button>
                    <button class="export-btn pdf" onclick="exportToPDF()">
                        <span>üìï</span> Xu·∫•t PDF (.pdf)
                    </button>
                    <button class="export-btn" onclick="exportToCSV()">
                        <span>üìò</span> Xu·∫•t CSV (.csv)
                    </button>
                </div>
                
                <div id="exportStatus" style="margin-top: 25px; padding: 15px; border-radius: 10px; display: none;"></div>
            </div>
            
            <div class="system-info">
                <h3 style="color: #2d5c2a; margin-bottom: 15px;">üìä T·ªïng k·∫øt d·ªØ li·ªáu xu·∫•t</h3>
                <div id="exportSummary">
                    <!-- Export summary will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Email Tab -->
        <div id="email-tab" class="tab-content">
            <div class="email-section">
                <h2 style="color: #2d5c2a; margin-bottom: 20px;">üìß Thi·∫øt l·∫≠p th√¥ng b√°o email</h2>
                <p style="color: #666; margin-bottom: 25px; font-size: 1.1em;">
                    Nh·∫≠n th√¥ng b√°o t·ª± ƒë·ªông khi c√≥ thay ƒë·ªïi d·ªØ li·ªáu. H·ªá th·ªëng s·∫Ω g·ª≠i email t·ªïng k·∫øt ƒë·∫ßy ƒë·ªß.
                </p>
                
                <div class="email-form">
                    <input type="email" id="emailInput" class="email-input" 
                           value="phongvumobie79@gmail.com" placeholder="Nh·∫≠p email nh·∫≠n th√¥ng b√°o">
                    
                    <select id="emailFrequency" class="email-input">
                        <option value="3">M·ªói 3 ph√∫t</option>
                        <option value="5">M·ªói 5 ph√∫t</option>
                        <option value="10">M·ªói 10 ph√∫t</option>
                        <option value="30">M·ªói 30 ph√∫t</option>
                        <option value="60">M·ªói gi·ªù</option>
                        <option value="change">Khi c√≥ thay ƒë·ªïi</option>
                    </select>
                    
                    <button class="email-btn" onclick="setupEmailNotification()">
                        <span>‚úÖ</span> Thi·∫øt l·∫≠p th√¥ng b√°o
                    </button>
                    
                    <button class="email-btn" onclick="sendTestEmail()" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                        <span>üì§</span> G·ª≠i email ki·ªÉm tra
                    </button>
                    
                    <button class="email-btn" onclick="sendSummaryEmail()" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
                        <span>üìä</span> G·ª≠i t·ªïng k·∫øt ngay
                    </button>
                </div>
                
                <div id="emailStatus" style="margin-top: 25px; padding: 20px; border-radius: 12px; background: white; display: none;"></div>
                
                <div class="system-info" style="margin-top: 30px;">
                    <h3 style="color: #2d5c2a; margin-bottom: 15px;">üìã N·ªôi dung email th√¥ng b√°o:</h3>
                    <div id="emailContentPreview">
                        <p>üìä <strong>T·ªïng chi ph√≠ l√†m v∆∞·ªùn:</strong> <span id="previewTotal">0 ‚Ç´</span></p>
                        <p>üõ†Ô∏è <strong>T·ªïng ph√≠ v·∫≠t t∆∞:</strong> <span id="previewVatTu">0 ‚Ç´</span></p>
                        <p>üë∑ <strong>T·ªïng ti·ªÅn c√¥ng:</strong> <span id="previewTienCong">0 ‚Ç´</span></p>
                        <p>üë® <strong>Tri·ªÅu:</strong> <span id="previewTrieu">0 ‚Ç´</span></p>
                        <p>üë® <strong>T√®o:</strong> <span id="previewTeo">0 ‚Ç´</span></p>
                        <p>üë® <strong>Thi·ªán:</strong> <span id="previewThien">0 ‚Ç´</span></p>
                        <p>üë® <strong>Thu·∫≠n:</strong> <span id="previewThuan">0 ‚Ç´</span></p>
                        <p>üìÖ <strong>Th·ªùi gian c·∫≠p nh·∫≠t:</strong> <span id="previewTime">--:--</span></p>
                        <p>üìà <strong>T·ªïng s·ªë giao d·ªãch:</strong> <span id="previewTransactions">0</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="system-info">
            <h3 style="color: #2d5c2a; margin-bottom: 15px;">‚ÑπÔ∏è Th√¥ng tin h·ªá th·ªëng</h3>
            <p><strong>Google Sheet ID:</strong> 1bVQzzwKmtqMwuCPUX0TJx9Fnsdbkuk57ncnX4HXU5v4</p>
            <p><strong>Sheet name:</strong> SR2526</p>
            <p><strong>Email th√¥ng b√°o:</strong> phongvumobie79@gmail.com</p>
            <p><strong>T·ª± ƒë·ªông c·∫≠p nh·∫≠t:</strong> M·ªói 3 ph√∫t</p>
            <p><strong>Tr·∫°ng th√°i:</strong> <span id="connectionStatus" style="color: #4CAF50;">‚úÖ ƒêang k·∫øt n·ªëi...</span></p>
        </div>
        
        <footer>
            <p>H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn th√¥ng minh - Phi√™n b·∫£n n√¢ng cao</p>
            <p>¬© 2025 | C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdate">ƒêang t·∫£i...</span></p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #888;">
                T√≠nh nƒÉng: Bi·ªÉu ƒë·ªì ‚Ä¢ T√¨m ki·∫øm ‚Ä¢ Xu·∫•t file ‚Ä¢ Th√¥ng b√°o email
            </p>
        </footer>
    </div>

    <script>
        // ============================
        // C·∫§U H√åNH H·ªÜ TH·ªêNG
        // ============================
        const SHEET_ID = '1bVQzzwKmtqMwuCPUX0TJx9Fnsdbkuk57ncnX4HXU5v4';
        const SHEET_NAME = 'SR2526';
        const AUTO_UPDATE_INTERVAL = 3 * 60 * 1000; // 3 ph√∫t
        const START_ROW = 3;
        const EMAILJS_CONFIG = {
            serviceId: 'service_0bwn16h',
            templateId: 'template_5j3m8e9',
            publicKey: 'GG5ID3V8_oCDmFCyA'
        };
        
        // Bi·∫øn h·ªá th·ªëng
        let currentData = [];
        let filteredData = [];
        let charts = {};
        let updateCount = 0;
        let lastUpdateTime = null;
        let autoUpdateTimer = null;
        let countdownTimer = null;
        let countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
        let emailNotificationInterval = null;
        let lastEmailData = null;
        
        // ============================
        // KH·ªûI T·∫†O H·ªÜ TH·ªêNG
        // ============================
        
        function initSystem() {
            // Kh·ªüi t·∫°o EmailJS
            emailjs.init(EMAILJS_CONFIG.publicKey);
            
            // C√†i ƒë·∫∑t th·ªùi gian
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // C√†i ƒë·∫∑t countdown timer
            startCountdown();
            
            // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
            loadData();
            
            // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t
            startAutoUpdate();
            
            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
            initCharts();
            
            // C·∫≠p nh·∫≠t preview email
            updateEmailPreview();
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentTime')?.textContent = timeString;
        }
        
        function startCountdown() {
            countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
            
            if (countdownTimer) clearInterval(countdownTimer);
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                
                const nextUpdateEl = document.getElementById('nextUpdate');
                if (nextUpdateEl) {
                    nextUpdateEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    loadData();
                    startCountdown();
                }
            }, 1000);
        }
        
        function startAutoUpdate() {
            if (autoUpdateTimer) clearInterval(autoUpdateTimer);
            
            autoUpdateTimer = setInterval(() => {
                loadData();
            }, AUTO_UPDATE_INTERVAL);
        }
        
        // ============================
        // TAB MANAGEMENT
        // ============================
        
        function switchTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // X√≥a active t·ª´ t·∫•t c·∫£ buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Th√™m active cho button
            event.target.classList.add('active');
            
            // N·∫øu l√† tab bi·ªÉu ƒë·ªì, c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
            if (tabName === 'charts') {
                setTimeout(() => {
                    updateCharts();
                }, 100);
            }
            
            // N·∫øu l√† tab export, c·∫≠p nh·∫≠t summary
            if (tabName === 'export') {
                updateExportSummary();
            }
        }
        
        // ============================
        // DATA LOADING & PROCESSING
        // ============================
        
        async function loadData() {
            try {
                updateConnectionStatus('üîÑ ƒêang t·∫£i d·ªØ li·ªáu...', '#FF9800');
                
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                const response = await fetch(csvUrl);
                
                if (!response.ok) throw new Error(`L·ªói k·∫øt n·ªëi: ${response.status}`);
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                // C·∫≠p nh·∫≠t th√¥ng tin h·ªá th·ªëng
                updateCount++;
                lastUpdateTime = new Date();
                
                document.getElementById('totalRows').textContent = rows.length;
                document.getElementById('updateCount')?.textContent = updateCount;
                document.getElementById('lastUpdateTime')?.textContent = 
                    lastUpdateTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                
                // L∆∞u d·ªØ li·ªáu
                currentData = rows;
                filteredData = [...rows];
                
                // X·ª≠ l√Ω v√† hi·ªÉn th·ªã d·ªØ li·ªáu
                processAndDisplayData(rows);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                updateConnectionStatus(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng (${rows.length} h√†ng)`, '#4CAF50');
                
                // C·∫≠p nh·∫≠t th·ªùi gian cu·ªëi
                const lastUpdateEl = document.getElementById('lastUpdate');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = lastUpdateTime.toLocaleString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }
                
                // Ki·ªÉm tra thay ƒë·ªïi v√† g·ª≠i email n·∫øu c√≥
                checkForChangesAndNotify();
                
                console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu l·∫ßn th·ª© ${updateCount}`);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                updateConnectionStatus('‚ùå L·ªói k·∫øt n·ªëi', '#f44336');
                setTimeout(loadData, 30000);
            }
        }
        
        function updateConnectionStatus(message, color) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = color;
            }
        }
        
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentRow.push(currentField);
                    rows.push(currentRow);
                    currentRow = [];
                    currentField = '';
                } else if (char === '\r') {
                    continue;
                } else {
                    currentField += char;
                }
            }
            
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                rows.push(currentRow);
            }
            
            return rows;
        }
        
        function processAndDisplayData(rows) {
            // T√≠nh t·ªïng v√† hi·ªÉn th·ªã
            const totals = calculateTotals(rows);
            displaySummaryCards(totals);
            displayDetailTable(rows);
            
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
            updateCharts();
            
            // C·∫≠p nh·∫≠t preview email
            updateEmailPreview();
            
            // C·∫≠p nh·∫≠t export summary
            updateExportSummary();
        }
        
        function calculateTotals(rows) {
            let totalVatTu = 0, totalTienCong = 0, totalTrieu = 0, totalTeo = 0, totalThien = 0, totalThuan = 0;
            let dataRowsCount = 0;
            
            for (let i = START_ROW - 1; i < rows.length; i++) {
                const row = rows[i];
                dataRowsCount++;
                
                if (row[3]) totalVatTu += parseSheetNumber(row[3]);
                if (row[4]) totalTienCong += parseSheetNumber(row[4]);
                if (row[6]) totalTrieu += parseSheetNumber(row[6]);
                if (row[7]) totalTeo += parseSheetNumber(row[7]);
                if (row[8]) totalThien += parseSheetNumber(row[8]);
                if (row[9]) totalThuan += parseSheetNumber(row[9]);
            }
            
            const totalChiPhi = totalVatTu + totalTienCong;
            
            return {
                totalChiPhi,
                totalVatTu,
                totalTienCong,
                totalTrieu,
                totalTeo,
                totalThien,
                totalThuan,
                dataRowsCount
            };
        }
        
        function parseSheetNumber(value) {
            if (!value && value !== 0) return 0;
            
            if (typeof value === 'string') {
                let cleanValue = value.replace(/\./g, '');
                cleanValue = cleanValue.replace(',', '.');
                cleanValue = cleanValue.replace(/[^\d.-]/g, '');
                
                const num = parseFloat(cleanValue);
                return isNaN(num) ? 0 : num;
            }
            
            return parseFloat(value) || 0;
        }
        
        // ============================
        // DISPLAY FUNCTIONS
        // ============================
        
        function displaySummaryCards(totals) {
            const summaryGrid = document.getElementById('summary');
            if (!summaryGrid) return;
            
            const cards = [
                { 
                    title: "üí∞ T·ªïng chi ph√≠ l√†m v∆∞·ªùn", 
                    value: totals.totalChiPhi, 
                    icon: "üí∞",
                    note: "T·ª± ƒë·ªông t√≠nh ƒë·∫øn h√†ng cu·ªëi c√πng" 
                },
                { 
                    title: "üõ†Ô∏è T·ªïng ph√≠ v·∫≠t t∆∞", 
                    value: totals.totalVatTu, 
                    icon: "üõ†Ô∏è",
                    note: "SUM(D3:D) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                },
                { 
                    title: "üë∑ T·ªïng ti·ªÅn c√¥ng", 
                    value: totals.totalTienCong, 
                    icon: "üë∑",
                    note: "SUM(E3:E) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                },
                { 
                    title: "üë® Tri·ªÅu", 
                    value: totals.totalTrieu, 
                    icon: "üë®",
                    note: "SUM(G3:G) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                },
                { 
                    title: "üë® T√®o", 
                    value: totals.totalTeo, 
                    icon: "üë®",
                    note: "SUM(H3:H) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                },
                { 
                    title: "üë® Thi·ªán", 
                    value: totals.totalThien, 
                    icon: "üë®",
                    note: "SUM(I3:I) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                },
                { 
                    title: "üë® Thu·∫≠n", 
                    value: totals.totalThuan, 
                    icon: "üë®",
                    note: "SUM(J3:J) - T·ª± ƒë·ªông ƒë·∫øn h√†ng cu·ªëi" 
                }
            ];
            
            let html = '';
            cards.forEach(card => {
                html += `
                    <div class="card">
                        <h3><span class="card-icon">${card.icon}</span> ${card.title}</h3>
                        <div class="amount">${formatCurrency(card.value)}</div>
                        <div class="note">${card.note}</div>
                    </div>
                `;
            });
            
            summaryGrid.innerHTML = html;
        }
        
        function displayDetailTable(rows) {
            const detailContent = document.getElementById('detailContent');
            if (!detailContent) return;
            
            document.getElementById('tableLoading').style.display = 'none';
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ID</th>
                            <th>Ng√†y</th>
                            <th>N·ªôi dung</th>
                            <th>Ph√≠ v·∫≠t t∆∞</th>
                            <th>Ti·ªÅn c√¥ng</th>
                            <th>Tri·ªÅu</th>
                            <th>T√®o</th>
                            <th>Thi·ªán</th>
                            <th>Thu·∫≠n</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let displayedCount = 0;
            
            for (let i = START_ROW - 1; i < rows.length; i++) {
                const row = rows[i];
                const rowNumber = i + 1;
                
                if (row && row.length >= 5) {
                    html += `
                        <tr>
                            <td>${rowNumber}</td>
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${row[2] || ''}</td>
                            <td>${displayAmount(row[3])}</td>
                            <td>${displayAmount(row[4])}</td>
                            <td>${displayAmount(row[6])}</td>
                            <td>${displayAmount(row[7])}</td>
                            <td>${displayAmount(row[8])}</td>
                            <td>${displayAmount(row[9])}</td>
                        </tr>
                    `;
                    displayedCount++;
                }
            }
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: #f5f9f5; border-radius: 10px;">
                    <p><strong>üìä T·ªïng s·ªë h√†ng d·ªØ li·ªáu:</strong> ${displayedCount}</p>
                    <p><strong>üìÖ C·∫≠p nh·∫≠t l√∫c:</strong> ${new Date().toLocaleTimeString('vi-VN')}</p>
                </div>
            `;
            
            detailContent.innerHTML = html;
        }
        
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return '0 ‚Ç´';
            }
            
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        function displayAmount(value) {
            if (!value && value !== 0) return '0 ‚Ç´';
            if (value === '' || value === '0') return '0 ‚Ç´';
            
            if (typeof value === 'string') {
                if (value.includes('.') && value.split('.').length > 1) {
                    if (!value.includes('‚Ç´') && !value.includes('ƒë')) {
                        return value + ' ‚Ç´';
                    }
                    return value;
                }
                
                if (/^\d+$/.test(value)) {
                    return parseInt(value).toLocaleString('vi-VN') + ' ‚Ç´';
                }
                
                if (!value.includes('‚Ç´') && !value.includes('ƒë')) {
                    return value + ' ‚Ç´';
                }
                return value;
            }
            
            if (typeof value === 'number') {
                return value.toLocaleString('vi-VN') + ' ‚Ç´';
            }
            
            return '0 ‚Ç´';
        }
        
        // ============================
        // CHARTS FUNCTIONS
        // ============================
        
        function initCharts() {
            // Kh·ªüi t·∫°o c√°c bi·ªÉu ƒë·ªì
            const chartConfigs = [
                { id: 'costDistributionChart', type: 'doughnut', label: 'Ph√¢n b·ªï chi ph√≠' },
                { id: 'monthlyCostChart', type: 'bar', label: 'Chi ph√≠ theo th√°ng' },
                { id: 'personCostChart', type: 'pie', label: 'Ph√¢n b·ªï ti·ªÅn c√¥ng' },
                { id: 'comparisonChart', type: 'bar', label: 'So s√°nh ph√≠ v·∫≠t t∆∞ vs ti·ªÅn c√¥ng' }
            ];
            
            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id).getContext('2d');
                charts[config.id] = new Chart(ctx, {
                    type: config.type,
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: config.label }
                        }
                    }
                });
            });
        }
        
        function updateCharts() {
            if (!currentData.length) return;
            
            const totals = calculateTotals(currentData);
            
            // 1. Bi·ªÉu ƒë·ªì ph√¢n b·ªï chi ph√≠
            updateCostDistributionChart(totals);
            
            // 2. Bi·ªÉu ƒë·ªì chi ph√≠ theo th√°ng
            updateMonthlyCostChart();
            
            // 3. Bi·ªÉu ƒë·ªì ph√¢n b·ªï ti·ªÅn c√¥ng
            updatePersonCostChart(totals);
            
            // 4. Bi·ªÉu ƒë·ªì so s√°nh
            updateComparisonChart(totals);
        }
        
        function updateCostDistributionChart(totals) {
            const chart = charts.costDistributionChart;
            chart.data = {
                labels: ['Ph√≠ v·∫≠t t∆∞', 'Ti·ªÅn c√¥ng'],
                datasets: [{
                    data: [totals.totalVatTu, totals.totalTienCong],
                    backgroundColor: ['#4CAF50', '#2196F3'],
                    borderColor: ['#388E3C', '#1976D2'],
                    borderWidth: 2
                }]
            };
            chart.update();
        }
        
        function updateMonthlyCostChart() {
            // Ph√¢n t√≠ch d·ªØ li·ªáu theo th√°ng
            const monthlyData = {};
            
            for (let i = START_ROW - 1; i < currentData.length; i++) {
                const row = currentData[i];
                const dateStr = row[1];
                if (!dateStr) continue;
                
                // Tr√≠ch xu·∫•t th√°ng t·ª´ ng√†y (ƒë·ªãnh d·∫°ng dd/mm/yyyy)
                const dateParts = dateStr.split('/');
                if (dateParts.length >= 2) {
                    const month = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[2]) || new Date().getFullYear();
                    const monthYear = `Th√°ng ${month}/${year}`;
                    
                    const vatTu = parseSheetNumber(row[3]) || 0;
                    const tienCong = parseSheetNumber(row[4]) || 0;
                    
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { vatTu: 0, tienCong: 0 };
                    }
                    
                    monthlyData[monthYear].vatTu += vatTu;
                    monthlyData[monthYear].tienCong += tienCong;
                }
            }
            
            const months = Object.keys(monthlyData).slice(-6); // L·∫•y 6 th√°ng g·∫ßn nh·∫•t
            const vatTuData = months.map(m => monthlyData[m].vatTu);
            const tienCongData = months.map(m => monthlyData[m].tienCong);
            
            const chart = charts.monthlyCostChart;
            chart.data = {
                labels: months,
                datasets: [
                    {
                        label: 'Ph√≠ v·∫≠t t∆∞',
                        data: vatTuData,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1
                    },
                    {
                        label: 'Ti·ªÅn c√¥ng',
                        data: tienCongData,
                        backgroundColor: '#2196F3',
                        borderColor: '#1976D2',
                        borderWidth: 1
                    }
                ]
            };
            chart.update();
        }
        
        function updatePersonCostChart(totals) {
            const chart = charts.personCostChart;
            chart.data = {
                labels: ['Tri·ªÅu', 'T√®o', 'Thi·ªán', 'Thu·∫≠n'],
                datasets: [{
                    data: [totals.totalTrieu, totals.totalTeo, totals.totalThien, totals.totalThuan],
                    backgroundColor: ['#FF9800', '#9C27B0', '#00BCD4', '#795548'],
                    borderColor: ['#F57C00', '#7B1FA2', '#0097A7', '#5D4037'],
                    borderWidth: 2
                }]
            };
            chart.update();
        }
        
        function updateComparisonChart(totals) {
            const chart = charts.comparisonChart;
            chart.data = {
                labels: ['So s√°nh'],
                datasets: [
                    {
                        label: 'Ph√≠ v·∫≠t t∆∞',
                        data: [totals.totalVatTu],
                        backgroundColor: '#4CAF50'
                    },
                    {
                        label: 'Ti·ªÅn c√¥ng',
                        data: [totals.totalTienCong],
                        backgroundColor: '#2196F3'
                    }
                ]
            };
            chart.update();
        }
        
        // ============================
        // SEARCH & FILTER FUNCTIONS
        // ============================
        
        function performSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            filteredData = currentData.filter((row, index) => {
                if (index < START_ROW - 1) return false;
                
                // T√¨m ki·∫øm theo text
                const matchesText = !searchText || 
                    row.some(cell => cell && cell.toString().toLowerCase().includes(searchText));
                
                // L·ªçc theo s·ªë ti·ªÅn (c·ªôt 3 v√† 4)
                const vatTu = parseSheetNumber(row[3]) || 0;
                const tienCong = parseSheetNumber(row[4]) || 0;
                const matchesAmount = (vatTu >= minAmount && vatTu <= maxAmount) ||
                                     (tienCong >= minAmount && tienCong <= maxAmount);
                
                // L·ªçc theo ng√†y
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const dateStr = row[1];
                    if (dateStr) {
                        const [day, month, year] = dateStr.split('/').map(Number);
                        const rowDate = new Date(year, month - 1, day);
                        
                        if (dateFrom) {
                            const fromDate = new Date(dateFrom);
                            matchesDate = matchesDate && rowDate >= fromDate;
                        }
                        
                        if (dateTo) {
                            const toDate = new Date(dateTo);
                            toDate.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && rowDate <= toDate;
                        }
                    }
                }
                
                return matchesText && matchesAmount && matchesDate;
            });
            
            displaySearchResults(filteredData);
        }
        
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minAmount').value = '';
            document.getElementById('maxAmount').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            filteredData = [...currentData];
            displaySearchResults(filteredData);
        }
        
        function filterByColumn(columnType) {
            const columnMap = {
                'vatTu': 3,
                'tienCong': 4,
                'trieu': 6,
                'teo': 7,
                'thien': 8,
                'thuan': 9
            };
            
            const columnIndex = columnMap[columnType];
            if (columnIndex === undefined) return;
            
            filteredData.sort((a, b) => {
                const valA = parseSheetNumber(a[columnIndex]) || 0;
                const valB = parseSheetNumber(b[columnIndex]) || 0;
                return valB - valA; // Gi·∫£m d·∫ßn
            });
            
            displaySearchResults(filteredData);
        }
        
        function sortByDate() {
            filteredData.sort((a, b) => {
                const dateA = parseDate(a[1]);
                const dateB = parseDate(b[1]);
                return dateB - dateA; // M·ªõi nh·∫•t tr∆∞·ªõc
            });
            
            displaySearchResults(filteredData);
        }
        
        function sortByAmount() {
            filteredData.sort((a, b) => {
                const totalA = (parseSheetNumber(a[3]) || 0) + (parseSheetNumber(a[4]) || 0);
                const totalB = (parseSheetNumber(b[3]) || 0) + (parseSheetNumber(b[4]) || 0);
                return totalB - totalA; // L·ªõn nh·∫•t tr∆∞·ªõc
            });
            
            displaySearchResults(filteredData);
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        }
        
        function displaySearchResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            const searchLoading = document.getElementById('searchLoading');
            
            searchLoading.style.display = 'none';
            
            if (!data.length || data.length <= START_ROW - 1) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>üîç Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3>
                        <p>Th·ª≠ v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c b·ªô l·ªçc kh√°c</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <p><strong>üìä K·∫øt qu·∫£ t√¨m ki·∫øm:</strong> ${data.length - START_ROW + 1} b·∫£n ghi</p>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ID</th>
                                <th>Ng√†y</th>
                                <th>N·ªôi dung</th>
                                <th>Ph√≠ v·∫≠t t∆∞</th>
                                <th>Ti·ªÅn c√¥ng</th>
                                <th>Tri·ªÅu</th>
                                <th>T√®o</th>
                                <th>Thi·ªán</th>
                                <th>Thu·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = START_ROW - 1; i < Math.min(data.length, START_ROW + 49); i++) {
                const row = data[i];
                const rowNumber = i + 1;
                
                if (row && row.length >= 5) {
                    html += `
                        <tr>
                            <td>${rowNumber}</td>
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${row[2] || ''}</td>
                            <td>${displayAmount(row[3])}</td>
                            <td>${displayAmount(row[4])}</td>
                            <td>${displayAmount(row[6])}</td>
                            <td>${displayAmount(row[7])}</td>
                            <td>${displayAmount(row[8])}</td>
                            <td>${displayAmount(row[9])}</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                ${data.length > START_ROW + 50 ? 
                    `<p style="margin-top: 15px; color: #666;">ƒêang hi·ªÉn th·ªã 50/${data.length - START_ROW + 1} b·∫£n ghi</p>` : ''}
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        // ============================
        // EXPORT FUNCTIONS
        // ============================
        
        function exportToExcel() {
            try {
                const data = prepareExportData();
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ChiPhiLamVuon");
                
                // Th√™m sheet t·ªïng k·∫øt
                const summaryData = prepareSummaryData();
                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws2, "TongKet");
                
                XLSX.writeFile(wb, `chi-phi-lam-vuon_${getCurrentDateTime()}.xlsx`);
                
                showNotification('‚úÖ Xu·∫•t Excel th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                showNotification('‚ùå L·ªói xu·∫•t Excel', 'error');
            }
        }
        
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Ti√™u ƒë·ªÅ
                doc.setFontSize(20);
                doc.text('B√ÅO C√ÅO CHI PH√ç L√ÄM V∆Ø·ªúN', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`, 105, 30, { align: 'center' });
                
                // T·ªïng k·∫øt
                const totals = calculateTotals(currentData);
                const summaryY = 45;
                
                doc.setFontSize(14);
                doc.text('T·ªîNG K·∫æT CHI PH√ç', 20, summaryY);
                doc.setFontSize(11);
                
                const summaryItems = [
                    `T·ªïng chi ph√≠ l√†m v∆∞·ªùn: ${formatCurrency(totals.totalChiPhi)}`,
                    `T·ªïng ph√≠ v·∫≠t t∆∞: ${formatCurrency(totals.totalVatTu)}`,
                    `T·ªïng ti·ªÅn c√¥ng: ${formatCurrency(totals.totalTienCong)}`,
                    `Tri·ªÅu: ${formatCurrency(totals.totalTrieu)}`,
                    `T√®o: ${formatCurrency(totals.totalTeo)}`,
                    `Thi·ªán: ${formatCurrency(totals.totalThien)}`,
                    `Thu·∫≠n: ${formatCurrency(totals.totalThuan)}`,
                    `T·ªïng s·ªë giao d·ªãch: ${totals.dataRowsCount}`
                ];
                
                summaryItems.forEach((item, index) => {
                    doc.text(item, 30, summaryY + 15 + (index * 7));
                });
                
                // B·∫£ng d·ªØ li·ªáu
                const data = prepareExportData();
                const tableY = summaryY + 15 + (summaryItems.length * 7) + 10;
                
                doc.autoTable({
                    head: [['ID', 'Ng√†y', 'N·ªôi dung', 'Ph√≠ v·∫≠t t∆∞', 'Ti·ªÅn c√¥ng', 'Tri·ªÅu', 'T√®o', 'Thi·ªán', 'Thu·∫≠n']],
                    body: data.map(row => [
                        row.ID,
                        row.Ngay,
                        row.NoiDung,
                        row['Ph√≠ v·∫≠t t∆∞'],
                        row['Ti·ªÅn c√¥ng'],
                        row.Tri·ªÅu,
                        row.T√®o,
                        row.Thi·ªán,
                        row.Thu·∫≠n
                    ]),
                    startY: tableY,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [76, 175, 80] }
                });
                
                doc.save(`chi-phi-lam-vuon_${getCurrentDateTime()}.pdf`);
                
                showNotification('‚úÖ Xu·∫•t PDF th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('L·ªói xu·∫•t PDF:', error);
                showNotification('‚ùå L·ªói xu·∫•t PDF', 'error');
            }
        }
        
        function exportToCSV() {
            try {
                const data = prepareExportData();
                const csvContent = convertToCSV(data);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                link.href = URL.createObjectURL(blob);
                link.download = `chi-phi-lam-vuon_${getCurrentDateTime()}.csv`;
                link.click();
                
                showNotification('‚úÖ Xu·∫•t CSV th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('L·ªói xu·∫•t CSV:', error);
                showNotification('‚ùå L·ªói xu·∫•t CSV', 'error');
            }
        }
        
        function prepareExportData() {
            const data = [];
            
            for (let i = START_ROW - 1; i < currentData.length; i++) {
                const row = currentData[i];
                if (row && row.length >= 5) {
                    data.push({
                        ID: row[0] || '',
                        Ngay: row[1] || '',
                        NoiDung: row[2] || '',
                        'Ph√≠ v·∫≠t t∆∞': displayAmount(row[3]),
                        'Ti·ªÅn c√¥ng': displayAmount(row[4]),
                        'Tri·ªÅu': displayAmount(row[6]),
                        'T√®o': displayAmount(row[7]),
                        'Thi·ªán': displayAmount(row[8]),
                        'Thu·∫≠n': displayAmount(row[9])
                    });
                }
            }
            
            return data;
        }
        
        function prepareSummaryData() {
            const totals = calculateTotals(currentData);
            return [{
                'Ch·ªâ s·ªë': 'Gi√° tr·ªã',
                'T·ªïng chi ph√≠ l√†m v∆∞·ªùn': formatCurrency(totals.totalChiPhi),
                'T·ªïng ph√≠ v·∫≠t t∆∞': formatCurrency(totals.totalVatTu),
                'T·ªïng ti·ªÅn c√¥ng': formatCurrency(totals.totalTienCong),
                'Tri·ªÅu': formatCurrency(totals.totalTrieu),
                'T√®o': formatCurrency(totals.totalTeo),
                'Thi·ªán': formatCurrency(totals.totalThien),
                'Thu·∫≠n': formatCurrency(totals.totalThuan),
                'T·ªïng s·ªë giao d·ªãch': totals.dataRowsCount,
                'Ng√†y xu·∫•t b√°o c√°o': new Date().toLocaleDateString('vi-VN'),
                'Th·ªùi gian xu·∫•t': new Date().toLocaleTimeString('vi-VN')
            }];
        }
        
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header];
                        return typeof cell === 'string' && cell.includes(',') ? 
                               `"${cell}"` : cell;
                    }).join(',')
                )
            ];
            return csvRows.join('\n');
        }
        
        function getCurrentDateTime() {
            const now = new Date();
            return now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
        }
        
        function updateExportSummary() {
            const totals = calculateTotals(currentData);
            const summaryDiv = document.getElementById('exportSummary');
            
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <p>üìä <strong>T·ªïng chi ph√≠ l√†m v∆∞·ªùn:</strong> ${formatCurrency(totals.totalChiPhi)}</p>
                    <p>üõ†Ô∏è <strong>T·ªïng ph√≠ v·∫≠t t∆∞:</strong> ${formatCurrency(totals.totalVatTu)}</p>
                    <p>üë∑ <strong>T·ªïng ti·ªÅn c√¥ng:</strong> ${formatCurrency(totals.totalTienCong)}</p>
                    <p>üë® <strong>Tri·ªÅu:</strong> ${formatCurrency(totals.totalTrieu)}</p>
                    <p>üë® <strong>T√®o:</strong> ${formatCurrency(totals.totalTeo)}</p>
                    <p>üë® <strong>Thi·ªán:</strong> ${formatCurrency(totals.totalThien)}</p>
                    <p>üë® <strong>Thu·∫≠n:</strong> ${formatCurrency(totals.totalThuan)}</p>
                    <p>üìà <strong>T·ªïng s·ªë giao d·ªãch:</strong> ${totals.dataRowsCount}</p>
                    <p>üìÖ <strong>D·ªØ li·ªáu t·ª´:</strong> H√†ng ${START_ROW} ƒë·∫øn ${currentData.length}</p>
                `;
            }
        }
        
        // ============================
        // EMAIL NOTIFICATION FUNCTIONS
        // ============================
        
        function setupEmailNotification() {
            const email = document.getElementById('emailInput').value;
            const frequency = document.getElementById('emailFrequency').value;
            
            if (!validateEmail(email)) {
                showEmailStatus('‚ö†Ô∏è Email kh√¥ng h·ª£p l·ªá', 'warning');
                return;
            }
            
            // X√≥a interval c≈© n·∫øu c√≥
            if (emailNotificationInterval) {
                clearInterval(emailNotificationInterval);
            }
            
            // Thi·∫øt l·∫≠p interval m·ªõi
            if (frequency !== 'change') {
                const minutes = parseInt(frequency);
                emailNotificationInterval = setInterval(() => {
                    sendSummaryEmail();
                }, minutes * 60 * 1000);
            }
            
            showEmailStatus(`‚úÖ ƒê√£ thi·∫øt l·∫≠p th√¥ng b√°o email cho ${email} (${getFrequencyText(frequency)})`, 'success');
            showNotification('‚úÖ ƒê√£ thi·∫øt l·∫≠p th√¥ng b√°o email!', 'success');
        }
        
        function sendTestEmail() {
            const email = document.getElementById('emailInput').value;
            
            if (!validateEmail(email)) {
                showEmailStatus('‚ö†Ô∏è Email kh√¥ng h·ª£p l·ªá', 'warning');
                return;
            }
            
            showEmailStatus('üîÑ ƒêang g·ª≠i email ki·ªÉm tra...', 'loading');
            
            const templateParams = {
                to_email: email,
                subject: 'üìß Ki·ªÉm tra th√¥ng b√°o - Chi ph√≠ l√†m v∆∞·ªùn',
                message: 'ƒê√¢y l√† email ki·ªÉm tra t·ª´ h·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn. N·∫øu b·∫°n nh·∫≠n ƒë∆∞·ª£c email n√†y, h·ªá th·ªëng th√¥ng b√°o ƒë√£ ho·∫°t ƒë·ªông!',
                total_chi_phi: 'Ki·ªÉm tra th√†nh c√¥ng',
                total_vat_tu: 'H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông',
                total_tien_cong: 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o',
                trieu: 'khi c√≥ thay ƒë·ªïi',
                teo: 'ho·∫∑c theo l·ªãch',
                thien: 'ƒë√£ thi·∫øt l·∫≠p',
                thuan: '',
                update_time: new Date().toLocaleString('vi-VN'),
                transaction_count: '1'
            };
            
            emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, templateParams)
                .then(() => {
                    showEmailStatus('‚úÖ ƒê√£ g·ª≠i email ki·ªÉm tra th√†nh c√¥ng!', 'success');
                    showNotification('‚úÖ ƒê√£ g·ª≠i email ki·ªÉm tra!', 'success');
                })
                .catch(error => {
                    console.error('L·ªói g·ª≠i email:', error);
                    showEmailStatus('‚ùå L·ªói g·ª≠i email: ' + error.text, 'error');
                });
        }
        
        function sendSummaryEmail() {
            const email = document.getElementById('emailInput').value;
            const totals = calculateTotals(currentData);
            
            if (!validateEmail(email)) {
                showEmailStatus('‚ö†Ô∏è Email kh√¥ng h·ª£p l·ªá', 'warning');
                return;
            }
            
            showEmailStatus('üîÑ ƒêang g·ª≠i t·ªïng k·∫øt qua email...', 'loading');
            
            const templateParams = {
                to_email: email,
                subject: `üìä T·ªïng k·∫øt chi ph√≠ l√†m v∆∞·ªùn - ${new Date().toLocaleDateString('vi-VN')}`,
                message: 'B√°o c√°o t·ªïng k·∫øt chi ph√≠ l√†m v∆∞·ªùn t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng:',
                total_chi_phi: formatCurrency(totals.totalChiPhi),
                total_vat_tu: formatCurrency(totals.totalVatTu),
                total_tien_cong: formatCurrency(totals.totalTienCong),
                trieu: formatCurrency(totals.totalTrieu),
                teo: formatCurrency(totals.totalTeo),
                thien: formatCurrency(totals.totalThien),
                thuan: formatCurrency(totals.totalThuan),
                update_time: new Date().toLocaleString('vi-VN'),
                transaction_count: totals.dataRowsCount
            };
            
            emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, templateParams)
                .then(() => {
                    showEmailStatus('‚úÖ ƒê√£ g·ª≠i t·ªïng k·∫øt qua email th√†nh c√¥ng!', 'success');
                    showNotification('‚úÖ ƒê√£ g·ª≠i email t·ªïng k·∫øt!', 'success');
                    lastEmailData = JSON.stringify(totals);
                })
                .catch(error => {
                    console.error('L·ªói g·ª≠i email:', error);
                    showEmailStatus('‚ùå L·ªói g·ª≠i email: ' + error.text, 'error');
                });
        }
        
        function checkForChangesAndNotify() {
            const totals = calculateTotals(currentData);
            const currentDataStr = JSON.stringify(totals);
            
            // N·∫øu c√≥ d·ªØ li·ªáu c≈© v√† c√≥ thay ƒë·ªïi
            if (lastEmailData && lastEmailData !== currentDataStr) {
                const email = document.getElementById('emailInput').value;
                if (validateEmail(email)) {
                    sendSummaryEmail();
                }
            }
            
            lastEmailData = currentDataStr;
        }
        
        function updateEmailPreview() {
            const totals = calculateTotals(currentData);
            
            document.getElementById('previewTotal').textContent = formatCurrency(totals.totalChiPhi);
            document.getElementById('previewVatTu').textContent = formatCurrency(totals.totalVatTu);
            document.getElementById('previewTienCong').textContent = formatCurrency(totals.totalTienCong);
            document.getElementById('previewTrieu').textContent = formatCurrency(totals.totalTrieu);
            document.getElementById('previewTeo').textContent = formatCurrency(totals.totalTeo);
            document.getElementById('previewThien').textContent = formatCurrency(totals.totalThien);
            document.getElementById('previewThuan').textContent = formatCurrency(totals.totalThuan);
            document.getElementById('previewTime').textContent = new Date().toLocaleTimeString('vi-VN');
            document.getElementById('previewTransactions').textContent = totals.dataRowsCount;
        }
        
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function getFrequencyText(frequency) {
            const texts = {
                '3': 'm·ªói 3 ph√∫t',
                '5': 'm·ªói 5 ph√∫t',
                '10': 'm·ªói 10 ph√∫t',
                '30': 'm·ªói 30 ph√∫t',
                '60': 'm·ªói gi·ªù',
                'change': 'khi c√≥ thay ƒë·ªïi'
            };
            return texts[frequency] || frequency;
        }
        
        function showEmailStatus(message, type) {
            const statusDiv = document.getElementById('emailStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.background = type === 'success' ? '#e8f5e9' : 
                                        type === 'error' ? '#ffebee' : 
                                        type === 'warning' ? '#fff3e0' : '#e3f2fd';
            statusDiv.style.color = type === 'success' ? '#2e7d32' : 
                                   type === 'error' ? '#c62828' : 
                                   type === 'warning' ? '#ef6c00' : '#1565c0';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <span style="font-size: 1.5em;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // ============================
        // INITIALIZE SYSTEM
        // ============================
        window.onload = initSystem;
        
        // Ph√≠m t·∫Øt
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                exportToExcel();
            }
            if (event.ctrlKey && event.key === 'p') {
                event.preventDefault();
                exportToPDF();
            }
            if (event.key === 'F5') {
                event.preventDefault();
                loadData();
            }
        });
    </script>
</body>
</html>
