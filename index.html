<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ph√≠ l√†m v∆∞·ªùn - T·ª± ƒë·ªông c·∫≠p nh·∫≠t</title>
    <style>
        /* C√°c style gi·ªØ nguy√™n t·ª´ code tr∆∞·ªõc */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(to right, #2e7d32, #4caf50);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .info-card h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card p {
            margin: 8px 0;
            font-size: 1rem;
        }

        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .summary-section h2 {
            color: #2e7d32;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .total-card {
            text-align: center;
            padding: 25px 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .total-card:hover {
            border-color: #4caf50;
            transform: scale(1.03);
        }

        .total-card h4 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .total-card .amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2e7d32;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(to right, #2196f3, #21cbf3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #4caf50, #8bc34a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(to right, #ff9800, #ffb74d);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(to right, #f44336, #ef5350);
            color: white;
        }

        /* Th√™m style cho form nh·∫≠p li·ªáu */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(to right, #2e7d32, #4caf50);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2e7d32;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4caf50;
        }

        .form-control:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-small {
            padding: 10px 25px;
            font-size: 0.9rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4caf50;
        }

        .amount-input {
            display: flex;
            align-items: center;
        }

        .amount-input .form-control {
            flex: 1;
        }

        .amount-input span {
            margin-left: 10px;
            font-weight: bold;
            color: #2e7d32;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .form-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .system-info,
            .totals-grid,
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåø Chi ph√≠ l√†m v∆∞·ªùn</h1>
            <p class="subtitle">H·ªá th·ªëng qu·∫£n l√Ω v√† theo d√µi chi ph√≠ t·ª± ƒë·ªông c·∫≠p nh·∫≠t</p>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                <span>‚è∞ Th·ªùi gian hi·ªán t·∫°i: <span id="currentTime">--:--:--</span></span>
                <span style="margin-left: 20px;">üìÖ NƒÉm: <span id="currentYear">2025</span></span>
            </div>
        </header>

        <!-- System Information -->
        <div class="system-info">
            <div class="info-card">
                <h3>üìä Tr·∫°ng th√°i h·ªá th·ªëng</h3>
                <p><strong>K·∫øt n·ªëi Google Sheet:</strong> <span id="connectionStatus">üîÑ ƒêang kh·ªüi t·∫°o...</span></p>
                <p><strong>T·ªïng s·ªë h√†ng:</strong> <span id="totalRows">0</span></p>
                <p><strong>S·ªë h√†ng d·ªØ li·ªáu:</strong> <span id="dataRows">0</span></p>
                <div class="debug-info" id="debugInfo" style="display: none;">
                    <small>Th√¥ng tin debug s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</small>
                </div>
            </div>
            
            <div class="info-card">
                <h3>üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông</h3>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="autoUpdateStatus">‚ö™</span></p>
                <p><strong>C·∫≠p nh·∫≠t ti·∫øp theo:</strong> <span id="nextUpdate">03:00</span></p>
                <p><strong>L·∫ßn c·∫≠p nh·∫≠t:</strong> <span id="updateCount">0</span></p>
            </div>
            
            <div class="info-card">
                <h3>‚è±Ô∏è Th·ªùi gian c·∫≠p nh·∫≠t</h3>
                <p><strong>L·∫ßn cu·ªëi c·∫≠p nh·∫≠t:</strong> <span id="lastUpdateTime">--:--</span></p>
                <p><strong>Th·ªùi gian th·ª±c:</strong> <span id="lastUpdate">--:--:--</span></p>
                <p><strong>Countdown:</strong> <span id="countdownTimer">180</span> gi√¢y</p>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2>üí∞ T·ªïng k·∫øt chi ph√≠</h2>
            <div class="totals-grid">
                <div class="total-card">
                    <h4>T·ªïng chi ph√≠</h4>
                    <div class="amount" id="totalChiPhi">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>T·ªïng ph√≠ v·∫≠t t∆∞</h4>
                    <div class="amount" id="totalVatTu">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>T·ªïng ti·ªÅn c√¥ng</h4>
                    <div class="amount" id="totalTienCong">0 ‚Ç´</div>
                </div>
            </div>
            
            <div class="totals-grid" style="margin-top: 20px;">
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Tri·ªÅu</h4>
                    <div class="amount" id="totalTrieu">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng T√®o</h4>
                    <div class="amount" id="totalTeo">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Thi·ªán</h4>
                    <div class="amount" id="totalThien">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Thu·∫≠n</h4>
                    <div class="amount" id="totalThuan">0 ‚Ç´</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons - TH√äM N√öT NH·∫¨P LI·ªÜU M·ªöI -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="toggleDetail()">
                <span id="detailButtonText">üìã Xem chi ti·∫øt d·ªØ li·ªáu</span>
            </button>
            <button class="btn btn-success" onclick="toggleChartSection()">
                <span id="chartButtonText">üìä Xem bi·ªÉu ƒë·ªì</span>
            </button>
            <!-- N√öT TH√äM M·ªöI -->
            <button class="btn btn-primary" onclick="showInputForm()" 
                    style="background: linear-gradient(to right, #9c27b0, #ba68c8);">
                ‚ú® Th√™m m·ªõi
            </button>
            <button class="btn btn-primary" onclick="loadData()" 
                    style="background: linear-gradient(to right, #2196f3, #21cbf3);">
                üîÑ C·∫≠p nh·∫≠t ngay
            </button>
        </div>

        <!-- FORM NH·∫¨P LI·ªÜU M·ªöI -->
        <div class="modal-overlay" id="inputFormModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ûï Th√™m d·ªØ li·ªáu m·ªõi</h3>
                    <button class="close-modal" onclick="hideInputForm()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="dataInputForm" onsubmit="return false;">
                        <div class="form-section">
                            <h4>üìù Th√¥ng tin c∆° b·∫£n</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="inputId">ID <span style="color: #666; font-size: 0.9rem;">(t·ª± ƒë·ªông)</span></label>
                                    <input type="text" id="inputId" class="form-control" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label for="inputNgay">Ng√†y *</label>
                                    <input type="date" id="inputNgay" class="form-control" required>
                                    <div class="error-message" id="errorNgay">Vui l√≤ng nh·∫≠p ng√†y</div>
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="inputNoiDung">N·ªôi dung c√¥ng vi·ªác *</label>
                                    <input type="text" id="inputNoiDung" class="form-control" placeholder="Nh·∫≠p n·ªôi dung c√¥ng vi·ªác..." required>
                                    <div class="error-message" id="errorNoiDung">Vui l√≤ng nh·∫≠p n·ªôi dung</div>
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="inputGhiChu">Ghi ch√∫</label>
                                    <textarea id="inputGhiChu" class="form-control" rows="3" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>üí∞ Chi ph√≠</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="inputPhiVatTu">Ph√≠ v·∫≠t t∆∞</label>
                                    <div class="amount-input">
                                        <input type="number" id="inputPhiVatTu" class="form-control" 
                                               placeholder="0" min="0" step="1000" value="0">
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="inputTienCong">Ti·ªÅn c√¥ng</label>
                                    <div class="amount-input">
                                        <input type="number" id="inputTienCong" class="form-control" 
                                               placeholder="0" min="0" step="1000" value="0">
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="inputTongCong">T·ªïng c·ªông <span style="color: #666; font-size: 0.9rem;">(t·ª± ƒë·ªông)</span></label>
                                    <div class="amount-input">
                                        <input type="text" id="inputTongCong" class="form-control" disabled value="0 ‚Ç´">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>üë∑ Ph√¢n b·ªï ti·ªÅn c√¥ng</h4>
                            <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                                Ch·ªçn c√¥ng nh√¢n tham gia v√† nh·∫≠p s·ªë ti·ªÅn c√¥ng cho t·ª´ng ng∆∞·ªùi:
                            </p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="checkTrieu" onchange="toggleWorkerInput('Trieu')">
                                        <label for="checkTrieu" style="color: #2e7d32; font-weight: bold;">Tri·ªÅu</label>
                                    </div>
                                    <div class="amount-input" style="margin-top: 10px;">
                                        <input type="number" id="inputTrieu" class="form-control worker-input" 
                                               placeholder="0" min="0" step="1000" value="0" disabled>
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="checkTeo" onchange="toggleWorkerInput('Teo')">
                                        <label for="checkTeo" style="color: #2196F3; font-weight: bold;">T√®o</label>
                                    </div>
                                    <div class="amount-input" style="margin-top: 10px;">
                                        <input type="number" id="inputTeo" class="form-control worker-input" 
                                               placeholder="0" min="0" step="1000" value="0" disabled>
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="checkThien" onchange="toggleWorkerInput('Thien')">
                                        <label for="checkThien" style="color: #FF9800; font-weight: bold;">Thi·ªán</label>
                                    </div>
                                    <div class="amount-input" style="margin-top: 10px;">
                                        <input type="number" id="inputThien" class="form-control worker-input" 
                                               placeholder="0" min="0" step="1000" value="0" disabled>
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="checkThuan" onchange="toggleWorkerInput('Thuan')">
                                        <label for="checkThuan" style="color: #9C27B0; font-weight: bold;">Thu·∫≠n</label>
                                    </div>
                                    <div class="amount-input" style="margin-top: 10px;">
                                        <input type="number" id="inputThuan" class="form-control worker-input" 
                                               placeholder="0" min="0" step="1000" value="0" disabled>
                                        <span>‚Ç´</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>T·ªïng ti·ªÅn c√¥ng ƒë√£ ph√¢n b·ªï: <span id="totalWorkerAmount">0 ‚Ç´</span></label>
                                <div class="error-message" id="errorWorkerAmount" style="display: none;">
                                    T·ªïng ti·ªÅn c√¥ng ph√¢n b·ªï ph·∫£i b·∫±ng v·ªõi t·ªïng ti·ªÅn c√¥ng
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-small" onclick="hideInputForm()" 
                                    style="background: #f0f0f0; color: #333;">
                                H·ªßy
                            </button>
                            <button type="button" class="btn btn-small" onclick="clearForm()" 
                                    style="background: #ff9800; color: white;">
                                X√≥a form
                            </button>
                            <button type="button" class="btn btn-small btn-success" onclick="saveData()">
                                üíæ L∆∞u d·ªØ li·ªáu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Detail Section -->
        <div class="collapsible-section" id="detailSection" style="display: none;">
            <div class="section-header" onclick="toggleDetail()">
                <h3>üìã Chi ti·∫øt d·ªØ li·ªáu</h3>
                <span>‚ñº</span>
            </div>
            <div class="section-content" id="detailContent">
                <div class="loading" id="loadingDetail">
                    <p>ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt...</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn &copy; <span id="currentYearFooter">2025</span></p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                Ch·∫ø ƒë·ªô: <span id="dataMode">D·ªØ li·ªáu m·∫´u</span> | 
                T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 3 ph√∫t
            </p>
        </footer>
    </div>

    <script>
        // ============================
        // C·∫§U H√åNH H·ªÜ TH·ªêNG
        // ============================
        const SHEET_ID = '1bVQzzwKmtqMwuCPUX0TJx9Fnsdbkuk57ncnX4HXU5v4';
        const SHEET_NAME = 'SR2526';
        const AUTO_UPDATE_INTERVAL = 3 * 60 * 1000; // 3 ph√∫t
        const START_ROW = 3; // B·∫Øt ƒë·∫ßu t·ª´ h√†ng 3
        
        // Bi·∫øn h·ªá th·ªëng
        let updateCount = 0;
        let lastUpdateTime = null;
        let autoUpdateTimer = null;
        let countdownTimer = null;
        let countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
        let isDetailVisible = false;
        
        // D·ªØ li·ªáu
        let currentRows = [];
        
        // ============================
        // CH·ª®C NƒÇNG NH·∫¨P LI·ªÜU M·ªöI
        // ============================
        
        // Hi·ªÉn th·ªã form nh·∫≠p li·ªáu
        function showInputForm() {
            // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputNgay').value = today;
            
            // T·∫°o ID m·ªõi
            generateNewId();
            
            // Hi·ªÉn th·ªã modal
            document.getElementById('inputFormModal').classList.add('active');
            
            // T√≠nh t·ªïng c·ªông ban ƒë·∫ßu
            calculateTotalAmount();
            
            // ƒê·∫∑t focus v√†o √¥ n·ªôi dung
            setTimeout(() => {
                document.getElementById('inputNoiDung').focus();
            }, 300);
        }
        
        // ·∫®n form nh·∫≠p li·ªáu
        function hideInputForm() {
            document.getElementById('inputFormModal').classList.remove('active');
        }
        
        // T·∫°o ID m·ªõi (t·ª± ƒë·ªông tƒÉng)
        function generateNewId() {
            if (!currentRows || currentRows.length === 0) {
                document.getElementById('inputId').value = "1";
                return;
            }
            
            // T√¨m ID l·ªõn nh·∫•t hi·ªán c√≥
            let maxId = 0;
            for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
                const row = currentRows[i];
                if (row && row.length > 0 && row[0]) {
                    const id = parseInt(row[0]);
                    if (!isNaN(id) && id > maxId) {
                        maxId = id;
                    }
                }
            }
            
            document.getElementById('inputId').value = (maxId + 1).toString();
        }
        
        // B·∫≠t/t·∫Øt √¥ nh·∫≠p li·ªáu cho c√¥ng nh√¢n
        function toggleWorkerInput(worker) {
            const checkbox = document.getElementById(`check${worker}`);
            const input = document.getElementById(`input${worker}`);
            
            if (checkbox.checked) {
                input.disabled = false;
                input.value = '';
                input.focus();
            } else {
                input.disabled = true;
                input.value = '0';
            }
            
            calculateWorkerTotal();
        }
        
        // T√≠nh t·ªïng ti·ªÅn c√¥ng ƒë√£ ph√¢n b·ªï
        function calculateWorkerTotal() {
            const workers = ['Trieu', 'Teo', 'Thien', 'Thuan'];
            let total = 0;
            
            workers.forEach(worker => {
                const checkbox = document.getElementById(`check${worker}`);
                if (checkbox.checked) {
                    const input = document.getElementById(`input${worker}`);
                    total += parseFloat(input.value) || 0;
                }
            });
            
            document.getElementById('totalWorkerAmount').textContent = formatCurrency(total);
            
            // Ki·ªÉm tra xem t·ªïng ti·ªÅn c√¥ng ph√¢n b·ªï c√≥ b·∫±ng t·ªïng ti·ªÅn c√¥ng kh√¥ng
            const tienCong = parseFloat(document.getElementById('inputTienCong').value) || 0;
            const errorElement = document.getElementById('errorWorkerAmount');
            
            if (Math.abs(total - tienCong) > 100) { // Cho ph√©p sai s·ªë nh·ªè
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
            
            return total;
        }
        
        // T√≠nh t·ªïng chi ph√≠
        function calculateTotalAmount() {
            const phiVatTu = parseFloat(document.getElementById('inputPhiVatTu').value) || 0;
            const tienCong = parseFloat(document.getElementById('inputTienCong').value) || 0;
            const total = phiVatTu + tienCong;
            
            document.getElementById('inputTongCong').value = formatCurrency(total);
            
            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn c√¥ng ph√¢n b·ªï
            calculateWorkerTotal();
            
            return total;
        }
        
        // X√≥a form
        function clearForm() {
            document.getElementById('dataInputForm').reset();
            
            // Reset c√°c √¥ input c√¥ng nh√¢n
            ['Trieu', 'Teo', 'Thien', 'Thuan'].forEach(worker => {
                document.getElementById(`input${worker}`).value = '0';
                document.getElementById(`input${worker}`).disabled = true;
                document.getElementById(`check${worker}`).checked = false;
            });
            
            // ƒê·∫∑t l·∫°i ng√†y l√† h√¥m nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputNgay').value = today;
            
            // T·∫°o ID m·ªõi
            generateNewId();
            
            // T√≠nh l·∫°i t·ªïng
            calculateTotalAmount();
            
            // X√≥a th√¥ng b√°o l·ªói
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
            });
        }
        
        // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p
        function validateForm() {
            let isValid = true;
            
            // Ki·ªÉm tra ng√†y
            const ngay = document.getElementById('inputNgay').value;
            if (!ngay) {
                document.getElementById('errorNgay').classList.add('show');
                isValid = false;
            } else {
                document.getElementById('errorNgay').classList.remove('show');
            }
            
            // Ki·ªÉm tra n·ªôi dung
            const noiDung = document.getElementById('inputNoiDung').value.trim();
            if (!noiDung) {
                document.getElementById('errorNoiDung').classList.add('show');
                isValid = false;
            } else {
                document.getElementById('errorNoiDung').classList.remove('show');
            }
            
            // Ki·ªÉm tra t·ªïng ti·ªÅn c√¥ng ph√¢n b·ªï
            const tienCong = parseFloat(document.getElementById('inputTienCong').value) || 0;
            const workerTotal = calculateWorkerTotal();
            
            if (tienCong > 0 && Math.abs(workerTotal - tienCong) > 100) {
                document.getElementById('errorWorkerAmount').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('errorWorkerAmount').style.display = 'none';
            }
            
            return isValid;
        }
        
        // L∆∞u d·ªØ li·ªáu
        async function saveData() {
            try {
                // Ki·ªÉm tra d·ªØ li·ªáu
                if (!validateForm()) {
                    alert('Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin nh·∫≠p!');
                    return;
                }
                
                // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang l∆∞u
                const saveButton = document.querySelector('.btn-success');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚è≥ ƒêang l∆∞u...';
                saveButton.disabled = true;
                
                // L·∫•y d·ªØ li·ªáu t·ª´ form
                const formData = {
                    id: document.getElementById('inputId').value,
                    ngay: document.getElementById('inputNgay').value,
                    noiDung: document.getElementById('inputNoiDung').value.trim(),
                    phiVatTu: parseFloat(document.getElementById('inputPhiVatTu').value) || 0,
                    tienCong: parseFloat(document.getElementById('inputTienCong').value) || 0,
                    ghiChu: document.getElementById('inputGhiChu').value.trim(),
                    trieu: document.getElementById('checkTrieu').checked ? 
                           (parseFloat(document.getElementById('inputTrieu').value) || 0) : 0,
                    teo: document.getElementById('checkTeo').checked ? 
                         (parseFloat(document.getElementById('inputTeo').value) || 0) : 0,
                    thien: document.getElementById('checkThien').checked ? 
                           (parseFloat(document.getElementById('inputThien').value) || 0) : 0,
                    thuan: document.getElementById('checkThuan').checked ? 
                           (parseFloat(document.getElementById('inputThuan').value) || 0) : 0
                };
                
                // ƒê·ªãnh d·∫°ng ng√†y theo dd/mm/yyyy
                const dateObj = new Date(formData.ngay);
                const formattedDate = `${dateObj.getDate().toString().padStart(2, '0')}/` +
                                     `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/` +
                                     `${dateObj.getFullYear()}`;
                
                // T·∫°o d√≤ng d·ªØ li·ªáu
                const rowData = [
                    formData.id,
                    formattedDate,
                    formData.noiDung,
                    formData.phiVatTu.toString(),
                    formData.tienCong.toString(),
                    formData.ghiChu,
                    formData.trieu.toString(),
                    formData.teo.toString(),
                    formData.thien.toString(),
                    formData.thuan.toString()
                ];
                
                // L∆∞u v√†o localStorage
                saveToLocalStorage(rowData);
                
                // Th√™m v√†o d·ªØ li·ªáu hi·ªán t·∫°i
                currentRows.push(rowData);
                
                // Th√†nh c√¥ng
                alert('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng v√†o b·ªô nh·ªõ t·∫°m!');
                
                // ƒê√≥ng form
                hideInputForm();
                
                // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu
                setTimeout(() => {
                    loadData();
                }, 1000);
                
            } catch (error) {
                console.error('L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu: ' + error.message);
            } finally {
                // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
                const saveButton = document.querySelector('.btn-success');
                saveButton.innerHTML = 'üíæ L∆∞u d·ªØ li·ªáu';
                saveButton.disabled = false;
            }
        }
        
        // L∆∞u v√†o localStorage
        function saveToLocalStorage(rowData) {
            try {
                // L·∫•y d·ªØ li·ªáu hi·ªán c√≥ t·ª´ localStorage
                const localStorageData = JSON.parse(localStorage.getItem('chiPhiLamVuon') || '[]');
                
                // Th√™m d·ªØ li·ªáu m·ªõi
                localStorageData.push({
                    id: rowData[0],
                    ngay: rowData[1],
                    noiDung: rowData[2],
                    phiVatTu: rowData[3],
                    tienCong: rowData[4],
                    ghiChu: rowData[5],
                    trieu: rowData[6],
                    teo: rowData[7],
                    thien: rowData[8],
                    thuan: rowData[9],
                    timestamp: new Date().toISOString()
                });
                
                // L∆∞u l·∫°i v√†o localStorage
                localStorage.setItem('chiPhiLamVuon', JSON.stringify(localStorageData));
                
                console.log('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu v√†o localStorage:', localStorageData.length, 'b·∫£n ghi');
                
                return true;
                
            } catch (error) {
                console.error('L·ªói khi l∆∞u v√†o localStorage:', error);
                return false;
            }
        }
        
        // ============================
        // KH·ªûI T·∫†O H·ªÜ TH·ªêNG
        // ============================
        
        // Kh·ªüi t·∫°o h·ªá th·ªëng
        function initSystem() {
            console.log('üîÑ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...');
            
            // C·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            document.getElementById('currentYearFooter').textContent = new Date().getFullYear();
            document.getElementById('dataMode').textContent = 'D·ªØ li·ªáu m·∫´u';
            
            // C·∫≠p nh·∫≠t th·ªùi gian th·ª±c
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // B·∫Øt ƒë·∫ßu countdown
            startCountdown();
            
            // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
            loadData();
            
            // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t
            startAutoUpdate();
            
            // Th√™m event listener cho c√°c √¥ nh·∫≠p s·ªë ti·ªÅn
            setupFormListeners();
            
            console.log('‚úÖ H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
        }
        
        // Thi·∫øt l·∫≠p event listener cho form
        function setupFormListeners() {
            // T·ª± ƒë·ªông t√≠nh t·ªïng khi thay ƒë·ªïi ph√≠ v·∫≠t t∆∞ ho·∫∑c ti·ªÅn c√¥ng
            document.getElementById('inputPhiVatTu').addEventListener('input', calculateTotalAmount);
            document.getElementById('inputTienCong').addEventListener('input', calculateTotalAmount);
            
            // T·ª± ƒë·ªông t√≠nh t·ªïng ti·ªÅn c√¥ng ph√¢n b·ªï
            document.querySelectorAll('.worker-input').forEach(input => {
                input.addEventListener('input', calculateWorkerTotal);
            });
            
            // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn khi m·∫•t focus
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value) {
                        const num = parseFloat(this.value);
                        if (!isNaN(num)) {
                            this.value = num.toLocaleString('vi-VN');
                        }
                    }
                });
                
                input.addEventListener('focus', function() {
                    if (this.value) {
                        const num = parseFloat(this.value.replace(/\./g, ''));
                        if (!isNaN(num)) {
                            this.value = num;
                        }
                    }
                });
            });
        }
        
        // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
        function startCountdown() {
            countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                
                document.getElementById('countdownTimer').textContent = countdownSeconds;
                document.getElementById('nextUpdate').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    loadData();
                    startCountdown();
                }
            }, 1000);
        }
        
        // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t
        function startAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
            }
            
            autoUpdateTimer = setInterval(() => {
                loadData();
            }, AUTO_UPDATE_INTERVAL);
            
            document.getElementById('autoUpdateStatus').textContent = 'üü¢';
            document.getElementById('autoUpdateStatus').style.color = '#4CAF50';
        }
        
        // ============================
        // X·ª¨ L√ù D·ªÆ LI·ªÜU
        // ============================
        
        // T·∫£i d·ªØ li·ªáu
        async function loadData() {
            try {
                console.log('üì• ƒêang t·∫£i d·ªØ li·ªáu...');
                
                document.getElementById('connectionStatus').textContent = 'üîÑ ƒêang t·∫£i d·ªØ li·ªáu...';
                document.getElementById('connectionStatus').style.color = '#FF9800';
                document.getElementById('debugInfo').style.display = 'block';
                document.getElementById('debugInfo').innerHTML = '<small>ƒêang k·∫øt n·ªëi...</small>';
                
                // Th·ª≠ k·∫øt n·ªëi v·ªõi Google Sheet
                const googleData = await tryGoogleSheetConnection();
                
                if (googleData.success) {
                    // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ Google Sheet
                    currentRows = googleData.data;
                    document.getElementById('connectionStatus').textContent = '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng';
                    document.getElementById('connectionStatus').style.color = '#4CAF50';
                    document.getElementById('dataMode').textContent = 'D·ªØ li·ªáu Google Sheet';
                } else {
                    // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ localStorage
                    const localStorageData = getDataFromLocalStorage();
                    
                    if (localStorageData.length > 0) {
                        // T·∫°o header cho d·ªØ li·ªáu
                        currentRows = [
                            ["ID", "Ng√†y", "N·ªôi dung", "Ph√≠ v·∫≠t t∆∞", "Ti·ªÅn c√¥ng", "Ghi ch√∫", "Tri·ªÅu", "T√®o", "Thi·ªán", "Thu·∫≠n"]
                        ];
                        
                        // Th√™m d·ªØ li·ªáu t·ª´ localStorage
                        localStorageData.forEach(item => {
                            currentRows.push([
                                item.id,
                                item.ngay,
                                item.noiDung,
                                item.phiVatTu,
                                item.tienCong,
                                item.ghiChu || '',
                                item.trieu,
                                item.teo,
                                item.thien,
                                item.thuan
                            ]);
                        });
                        
                        document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ l∆∞u';
                        document.getElementById('connectionStatus').style.color = '#FF9800';
                        document.getElementById('dataMode').textContent = `D·ªØ li·ªáu ƒë√£ l∆∞u (${localStorageData.length} b·∫£n ghi)`;
                        document.getElementById('debugInfo').innerHTML = `<small>S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ t·∫°m: ${localStorageData.length} b·∫£n ghi</small>`;
                    } else {
                        // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u
                        showSampleData();
                        document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u';
                        document.getElementById('connectionStatus').style.color = '#FF9800';
                        document.getElementById('dataMode').textContent = 'D·ªØ li·ªáu m·∫´u';
                        document.getElementById('debugInfo').innerHTML = '<small>S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u</small>';
                    }
                }
                
                // X·ª≠ l√Ω d·ªØ li·ªáu th√†nh c√¥ng
                processDataSuccess();
                
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                
                // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u
                showSampleData();
                
                document.getElementById('connectionStatus').textContent = '‚ùå L·ªói k·∫øt n·ªëi';
                document.getElementById('connectionStatus').style.color = '#f44336';
                document.getElementById('debugInfo').innerHTML = `<small>L·ªói: ${error.message}. ƒêang d√πng d·ªØ li·ªáu m·∫´u.</small>`;
                
                // Th·ª≠ l·∫°i sau 30 gi√¢y
                setTimeout(loadData, 30000);
            }
        }
        
        // Th·ª≠ k·∫øt n·ªëi v·ªõi Google Sheet
        async function tryGoogleSheetConnection() {
            try {
                // Th·ª≠ c√°c ph∆∞∆°ng ph√°p kh√°c nhau ƒë·ªÉ k·∫øt n·ªëi
                const methods = [
                    tryGoogleSheetsAPI,
                    tryCSVExport,
                    tryPublicAccess
                ];
                
                for (const method of methods) {
                    try {
                        const result = await method();
                        if (result.success) {
                            return result;
                        }
                    } catch (error) {
                        console.log(`Method failed: ${method.name}`, error);
                        continue;
                    }
                }
                
                throw new Error('T·∫•t c·∫£ ph∆∞∆°ng ph√°p k·∫øt n·ªëi ƒë·ªÅu th·∫•t b·∫°i');
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // Th·ª≠ Google Sheets API
        async function tryGoogleSheetsAPI() {
            // S·ª≠ d·ª•ng API key c√¥ng khai
            const API_KEY = 'AIzaSyC9Jw2CTp7pdnc2j6nO3h0zY3lK6U2B1Y0';
            const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.values && data.values.length > 0) {
                return {
                    success: true,
                    data: data.values
                };
            } else {
                throw new Error('Sheet tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu');
            }
        }
        
        // Th·ª≠ CSV export
        async function tryCSVExport() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
            const response = await fetch(csvUrl);
            
            if (!response.ok) {
                throw new Error(`CSV Error: ${response.status}`);
            }
            
            const csvText = await response.text();
            const rows = parseCSV(csvText);
            
            return {
                success: true,
                data: rows
            };
        }
        
        // Th·ª≠ public access
        async function tryPublicAccess() {
            const publicUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?output=csv`;
            const response = await fetch(publicUrl);
            
            if (!response.ok) {
                throw new Error(`Public Error: ${response.status}`);
            }
            
            const csvText = await response.text();
            const rows = parseCSV(csvText);
            
            return {
                success: true,
                data: rows
            };
        }
        
        // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
        function getDataFromLocalStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('chiPhiLamVuon') || '[]');
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc t·ª´ localStorage:', error);
                return [];
            }
        }
        
        // X·ª≠ l√Ω d·ªØ li·ªáu th√†nh c√¥ng
        function processDataSuccess() {
            updateCount++;
            lastUpdateTime = new Date();
            
            document.getElementById('totalRows').textContent = currentRows.length;
            document.getElementById('updateCount').textContent = updateCount;
            document.getElementById('lastUpdateTime').textContent = 
                lastUpdateTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            // T√≠nh to√°n v√† hi·ªÉn th·ªã t·ªïng
            calculateAndDisplayTotals(currentRows);
            
            document.getElementById('lastUpdate').textContent = 
                lastUpdateTime.toLocaleString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            
            // C·∫≠p nh·∫≠t c√°c ph·∫ßn hi·ªÉn th·ªã n·∫øu ƒëang m·ªü
            if (isDetailVisible) {
                displayDetailTable(currentRows);
            }
            
            console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu l·∫ßn ${updateCount} (${currentRows.length} h√†ng)`);
        }
        
        // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u
        function showSampleData() {
            currentRows = [
                ["ID", "Ng√†y", "N·ªôi dung", "Ph√≠ v·∫≠t t∆∞", "Ti·ªÅn c√¥ng", "Ghi ch√∫", "Tri·ªÅu", "T√®o", "Thi·ªán", "Thu·∫≠n"],
                ["1", "01/01/2025", "Mua ph√¢n b√≥n", "500000", "300000", "Mua t·∫°i c·ª≠a h√†ng A", "150000", "150000", "0", "0"],
                ["2", "02/01/2025", "Thu√™ m√°y c√†y", "0", "1000000", "Thu√™ 1 ng√†y", "500000", "500000", "0", "0"],
                ["3", "03/01/2025", "Mua c√¢y gi·ªëng", "800000", "200000", "C√¢y ƒÉn qu·∫£", "100000", "100000", "0", "0"],
                ["4", "05/01/2025", "L√†m c·ªè", "0", "600000", "Khu v·ª±c A", "200000", "200000", "200000", "0"],
                ["5", "06/01/2025", "T∆∞·ªõi ti√™u", "300000", "400000", "L·∫Øp h·ªá th·ªëng", "100000", "100000", "100000", "100000"]
            ];
            
            calculateAndDisplayTotals(currentRows);
            
            if (isDetailVisible) {
                displayDetailTable(currentRows);
            }
        }
        
        // Ph√¢n t√≠ch CSV
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const row = [];
                    let inQuotes = false;
                    let field = '';
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(field);
                            field = '';
                        } else {
                            field += char;
                        }
                    }
                    
                    row.push(field);
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // ƒê·ªãnh d·∫°ng ti·ªÅn Vi·ªát Nam
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value) || value === 0) {
                return '0 ‚Ç´';
            }
            
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Hi·ªÉn th·ªã s·ªë ti·ªÅn
        function displayAmount(value) {
            if (!value && value !== 0) return '0 ‚Ç´';
            
            if (typeof value === 'string') {
                const cleanValue = value.replace(/[^\d.,]/g, '');
                if (!cleanValue) return '0 ‚Ç´';
                
                const num = parseFloat(cleanValue.replace(/\./g, '').replace(',', '.'));
                return isNaN(num) ? '0 ‚Ç´' : formatCurrency(num);
            }
            
            return formatCurrency(value);
        }
        
        // Chuy·ªÉn ƒë·ªïi s·ªë t·ª´ Google Sheet
        function parseSheetNumber(value) {
            if (!value && value !== 0) return 0;
            
            if (typeof value === 'string') {
                const cleanValue = value.replace(/[^\d.,-]/g, '');
                if (!cleanValue) return 0;
                
                const num = parseFloat(cleanValue.replace(/\./g, '').replace(',', '.'));
                return isNaN(num) ? 0 : num;
            }
            
            return parseFloat(value) || 0;
        }
        
        // T√≠nh to√°n v√† hi·ªÉn th·ªã t·ªïng
        function calculateAndDisplayTotals(rows) {
            let totalVatTu = 0;
            let totalTienCong = 0;
            let totalTrieu = 0;
            let totalTeo = 0;
            let totalThien = 0;
            let totalThuan = 0;
            
            let dataRowsCount = 0;
            
            // B·∫Øt ƒë·∫ßu t·ª´ START_ROW (h√†ng th·ª© 3)
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 5) {
                    dataRowsCount++;
                    
                    totalVatTu += parseSheetNumber(row[3]);
                    totalTienCong += parseSheetNumber(row[4]);
                    
                    // C√°c c·ªôt c√¥ng nh√¢n (b·∫Øt ƒë·∫ßu t·ª´ c·ªôt 6)
                    if (row.length > 6) totalTrieu += parseSheetNumber(row[6]);
                    if (row.length > 7) totalTeo += parseSheetNumber(row[7]);
                    if (row.length > 8) totalThien += parseSheetNumber(row[8]);
                    if (row.length > 9) totalThuan += parseSheetNumber(row[9]);
                }
            }
            
            const totalChiPhi = totalVatTu + totalTienCong;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('totalChiPhi').textContent = formatCurrency(totalChiPhi);
            document.getElementById('totalVatTu').textContent = formatCurrency(totalVatTu);
            document.getElementById('totalTienCong').textContent = formatCurrency(totalTienCong);
            document.getElementById('totalTrieu').textContent = formatCurrency(totalTrieu);
            document.getElementById('totalTeo').textContent = formatCurrency(totalTeo);
            document.getElementById('totalThien').textContent = formatCurrency(totalThien);
            document.getElementById('totalThuan').textContent = formatCurrency(totalThuan);
            
            document.getElementById('dataRows').textContent = dataRowsCount;
            
            console.log('üìä T·ªïng k·∫øt:', {
                'T·ªïng h√†ng': dataRowsCount,
                'T·ªïng chi ph√≠': formatCurrency(totalChiPhi),
                'Ph√≠ v·∫≠t t∆∞': formatCurrency(totalVatTu),
                'Ti·ªÅn c√¥ng': formatCurrency(totalTienCong)
            });
        }
        
        // Hi·ªÉn th·ªã/·∫©n chi ti·∫øt
        function toggleDetail() {
            const detailSection = document.getElementById('detailSection');
            const detailButton = document.getElementById('detailButtonText');
            
            isDetailVisible = !isDetailVisible;
            
            if (isDetailVisible) {
                detailSection.style.display = 'block';
                detailButton.textContent = '·∫®n chi ti·∫øt';
                displayDetailTable(currentRows);
            } else {
                detailSection.style.display = 'none';
                detailButton.textContent = 'üìã Xem chi ti·∫øt d·ªØ li·ªáu';
            }
        }
        
        // Hi·ªÉn th·ªã b·∫£ng chi ti·∫øt
        function displayDetailTable(rows) {
            const detailContent = document.getElementById('detailContent');
            
            if (!rows || rows.length === 0) {
                detailContent.innerHTML = '<div class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(to right, #4caf50, #66bb6a); color: white;">
                                <th style="padding: 15px; text-align: left;">STT</th>
                                <th style="padding: 15px; text-align: left;">ID</th>
                                <th style="padding: 15px; text-align: left;">Ng√†y</th>
                                <th style="padding: 15px; text-align: left;">N·ªôi dung</th>
                                <th style="padding: 15px; text-align: left;">Ph√≠ v·∫≠t t∆∞</th>
                                <th style="padding: 15px; text-align: left;">Ti·ªÅn c√¥ng</th>
                                <th style="padding: 15px; text-align: left;">Tri·ªÅu</th>
                                <th style="padding: 15px; text-align: left;">T√®o</th>
                                <th style="padding: 15px; text-align: left;">Thi·ªán</th>
                                <th style="padding: 15px; text-align: left;">Thu·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let displayedCount = 0;
            
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 5) {
                    const rowNumber = i + 1;
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px 15px;">${rowNumber}</td>
                            <td style="padding: 12px 15px;">${row[0] || ''}</td>
                            <td style="padding: 12px 15px;">${row[1] || ''}</td>
                            <td style="padding: 12px 15px;">${row[2] || ''}</td>
                            <td style="padding: 12px 15px;">${displayAmount(row[3])}</td>
                            <td style="padding: 12px 15px;">${displayAmount(row[4])}</td>
                            <td style="padding: 12px 15px;">${row.length > 6 ? displayAmount(row[6]) : '0 ‚Ç´'}</td>
                            <td style="padding: 12px 15px;">${row.length > 7 ? displayAmount(row[7]) : '0 ‚Ç´'}</td>
                            <td style="padding: 12px 15px;">${row.length > 8 ? displayAmount(row[8]) : '0 ‚Ç´'}</td>
                            <td style="padding: 12px 15px;">${row.length > 9 ? displayAmount(row[9]) : '0 ‚Ç´'}</td>
                        </tr>
                    `;
                    displayedCount++;
                }
            }
            
            html += `
                        </tbody>
                    </table>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4caf50;">
                        <p><strong>üìà Th·ªëng k√™ chi ti·∫øt:</strong></p>
                        <p>T·ªïng s·ªë h√†ng: ${displayedCount}</p>
                        <p>Th·ªùi gian: ${new Date().toLocaleTimeString('vi-VN')}</p>
                    </div>
                </div>
            `;
            
            detailContent.innerHTML = html;
            if (document.getElementById('loadingDetail')) {
                document.getElementById('loadingDetail').style.display = 'none';
            }
        }
        
        // Hi·ªÉn th·ªã/·∫©n bi·ªÉu ƒë·ªì (t·∫°m th·ªùi ƒë∆°n gi·∫£n)
        function toggleChartSection() {
            alert('Ch·ª©c nƒÉng bi·ªÉu ƒë·ªì ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Xem chi ti·∫øt d·ªØ li·ªáu".');
        }
        
        // ============================
        // KH·ªûI CH·∫†Y H·ªÜ TH·ªêNG
        // ============================
        
        // Kh·ªüi ch·∫°y khi trang ƒë√£ t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Trang ƒë√£ s·∫µn s√†ng, ƒëang kh·ªüi t·∫°o h·ªá th·ªëng...');
            initSystem();
        });
        
        // ƒê√≥ng modal khi click ra ngo√†i
        document.getElementById('inputFormModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideInputForm();
            }
        });
        
        // ƒê√≥ng modal b·∫±ng ph√≠m ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideInputForm();
            }
            
            // Refresh b·∫±ng F5
            if (event.key === 'F5') {
                event.preventDefault();
                loadData();
            }
        });
        
        // X·ª≠ l√Ω l·ªói to√†n c·ª•c
        window.addEventListener('error', function(event) {
            console.error('L·ªói h·ªá th·ªëng:', event.error);
            document.getElementById('connectionStatus').textContent = '‚ùå L·ªói h·ªá th·ªëng';
            document.getElementById('connectionStatus').style.color = '#f44336';
        });
    </script>
</body>
</html>
