<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ph√≠ l√†m v∆∞·ªùn - T·ª± ƒë·ªông c·∫≠p nh·∫≠t</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(to right, #2e7d32, #4caf50);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        /* System Info Styles */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .info-card h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card p {
            margin: 8px 0;
            font-size: 1rem;
        }

        /* Summary Section */
        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .summary-section h2 {
            color: #2e7d32;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .total-card {
            text-align: center;
            padding: 25px 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .total-card:hover {
            border-color: #4caf50;
            transform: scale(1.03);
        }

        .total-card h4 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .total-card .amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2e7d32;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(to right, #2196f3, #21cbf3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #4caf50, #8bc34a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(to right, #ff9800, #ffb74d);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(to right, #f44336, #ef5350);
            color: white;
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .section-header {
            padding: 20px 30px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header h3 {
            color: #2e7d32;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 30px;
            display: none;
        }

        .section-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th {
            background: linear-gradient(to right, #4caf50, #66bb6a);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background-color: #f5f5f5;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .chart-box h4 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        /* Search and Filter */
        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .filter-group h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4caf50;
        }

        /* Export Section */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .export-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .export-card:hover {
            border-color: #4caf50;
            transform: translateY(-5px);
        }

        .export-card h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.3s;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .system-info,
            .totals-grid,
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }

        /* Utility Classes */
        .highlight {
            background-color: #fff9c4;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .data-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        /* Debug Info */
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }
    </style>
    <!-- Chart.js library for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåø Chi ph√≠ l√†m v∆∞·ªùn</h1>
            <p class="subtitle">H·ªá th·ªëng qu·∫£n l√Ω v√† theo d√µi chi ph√≠ t·ª± ƒë·ªông c·∫≠p nh·∫≠t</p>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                <span>‚è∞ Th·ªùi gian hi·ªán t·∫°i: <span id="currentTime">--:--:--</span></span>
                <span style="margin-left: 20px;">üìÖ NƒÉm: <span id="currentYear">2024</span></span>
            </div>
        </header>

        <!-- System Information -->
        <div class="system-info">
            <div class="info-card">
                <h3>üìä Tr·∫°ng th√°i h·ªá th·ªëng</h3>
                <p><strong>K·∫øt n·ªëi Google Sheet:</strong> <span id="connectionStatus">üîÑ ƒêang kh·ªüi t·∫°o...</span></p>
                <p><strong>T·ªïng s·ªë h√†ng:</strong> <span id="totalRows">0</span></p>
                <p><strong>S·ªë h√†ng d·ªØ li·ªáu:</strong> <span id="dataRows">0</span></p>
                <div class="debug-info" id="debugInfo" style="display: none; margin-top: 10px;">
                    <small>Th√¥ng tin debug s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</small>
                </div>
            </div>
            
            <div class="info-card">
                <h3>üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông</h3>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="autoUpdateStatus">‚ö™</span></p>
                <p><strong>C·∫≠p nh·∫≠t ti·∫øp theo:</strong> <span id="nextUpdate">03:00</span></p>
                <p><strong>L·∫ßn c·∫≠p nh·∫≠t:</strong> <span id="updateCount">0</span></p>
            </div>
            
            <div class="info-card">
                <h3>‚è±Ô∏è Th·ªùi gian c·∫≠p nh·∫≠t</h3>
                <p><strong>L·∫ßn cu·ªëi c·∫≠p nh·∫≠t:</strong> <span id="lastUpdateTime">--:--</span></p>
                <p><strong>Th·ªùi gian th·ª±c:</strong> <span id="lastUpdate">--:--:--</span></p>
                <p><strong>Countdown:</strong> <span id="countdownTimer">180</span> gi√¢y</p>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2>üí∞ T·ªïng k·∫øt chi ph√≠</h2>
            <div class="totals-grid">
                <div class="total-card">
                    <h4>T·ªïng chi ph√≠</h4>
                    <div class="amount" id="totalChiPhi">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>T·ªïng ph√≠ v·∫≠t t∆∞</h4>
                    <div class="amount" id="totalVatTu">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>T·ªïng ti·ªÅn c√¥ng</h4>
                    <div class="amount" id="totalTienCong">0 ‚Ç´</div>
                </div>
            </div>
            
            <div class="totals-grid" style="margin-top: 20px;">
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Tri·ªÅu</h4>
                    <div class="amount" id="totalTrieu">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng T√®o</h4>
                    <div class="amount" id="totalTeo">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Thi·ªán</h4>
                    <div class="amount" id="totalThien">0 ‚Ç´</div>
                </div>
                <div class="total-card">
                    <h4>Ti·ªÅn c√¥ng Thu·∫≠n</h4>
                    <div class="amount" id="totalThuan">0 ‚Ç´</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="toggleDetail()">
                <span id="detailButtonText">üìã Xem chi ti·∫øt d·ªØ li·ªáu</span>
            </button>
            <button class="btn btn-success" onclick="toggleChartSection()">
                <span id="chartButtonText">üìä Xem bi·ªÉu ƒë·ªì</span>
            </button>
            <button class="btn btn-warning" onclick="toggleSearchSection()">
                <span id="searchButtonText">üîç T√¨m ki·∫øm & L·ªçc</span>
            </button>
            <button class="btn btn-danger" onclick="toggleExportSection()">
                <span id="exportButtonText">üìÅ Xu·∫•t file</span>
            </button>
            <button class="btn btn-primary" onclick="loadData()" style="background: linear-gradient(to right, #9c27b0, #ba68c8);">
                üîÑ C·∫≠p nh·∫≠t ngay
            </button>
        </div>

        <!-- Detail Section -->
        <div class="collapsible-section" id="detailSection" style="display: none;">
            <div class="section-header" onclick="toggleDetail()">
                <h3>üìã Chi ti·∫øt d·ªØ li·ªáu</h3>
                <span>‚ñº</span>
            </div>
            <div class="section-content" id="detailContent">
                <div class="loading" id="loadingDetail">
                    <p>ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt...</p>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="collapsible-section" id="chartSection">
            <div class="section-header" onclick="toggleChartSection()">
                <h3>üìä Bi·ªÉu ƒë·ªì tr·ª±c quan</h3>
                <span>‚ñº</span>
            </div>
            <div class="section-content">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn" onclick="changeChartType('pie')" style="padding: 8px 15px; margin: 0 5px; background: #f0f0f0;">Pie Chart</button>
                    <button class="btn" onclick="changeChartType('bar')" style="padding: 8px 15px; margin: 0 5px; background: #f0f0f0;">Bar Chart</button>
                    <button class="btn" onclick="changeChartType('line')" style="padding: 8px 15px; margin: 0 5px; background: #f0f0f0;">Line Chart</button>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-box">
                        <h4>üìà Ph√¢n b·ªï chi ph√≠</h4>
                        <div class="chart-container">
                            <canvas id="costDistributionChart"></canvas>
                        </div>
                        <div class="legend" id="costChartLegend"></div>
                    </div>
                    
                    <div class="chart-box">
                        <h4>üë∑ Ti·ªÅn c√¥ng theo c√¥ng nh√¢n</h4>
                        <div class="chart-container">
                            <canvas id="workerChart"></canvas>
                        </div>
                        <div class="legend" id="workerChartLegend"></div>
                    </div>
                </div>
                
                <div class="chart-box" style="margin-top: 30px;">
                    <h4>üìÖ Xu h∆∞·ªõng chi ph√≠ theo th·ªùi gian</h4>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="collapsible-section" id="searchSection">
            <div class="section-header" onclick="toggleSearchSection()">
                <h3>üîç T√¨m ki·∫øm & L·ªçc d·ªØ li·ªáu</h3>
                <span>‚ñº</span>
            </div>
            <div class="section-content">
                <div class="search-filters">
                    <div class="filter-group">
                        <h4>T·ª´ kh√≥a t√¨m ki·∫øm</h4>
                        <input type="text" id="searchInput" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a..." oninput="filterTable()">
                    </div>
                    
                    <div class="filter-group">
                        <h4>Danh m·ª•c</h4>
                        <select id="categoryFilter" class="form-control" onchange="filterTable()">
                            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                            <option value="vat_tu">Ch·ªâ ph√≠ v·∫≠t t∆∞</option>
                            <option value="tien_cong">Ch·ªâ ti·ªÅn c√¥ng</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <h4>C√¥ng nh√¢n</h4>
                        <select id="workerFilter" class="form-control" onchange="filterTable()">
                            <option value="">T·∫•t c·∫£ c√¥ng nh√¢n</option>
                            <option value="Tri·ªÅu">Tri·ªÅu</option>
                            <option value="T√®o">T√®o</option>
                            <option value="Thi·ªán">Thi·ªán</option>
                            <option value="Thu·∫≠n">Thu·∫≠n</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <h4>M·ª©c chi ph√≠</h4>
                        <select id="amountFilter" class="form-control" onchange="filterTable()">
                            <option value="">M·ªçi m·ª©c chi ph√≠</option>
                            <option value="0-500000">D∆∞·ªõi 500,000 ‚Ç´</option>
                            <option value="500000-1000000">500,000 - 1,000,000 ‚Ç´</option>
                            <option value="1000000-5000000">1,000,000 - 5,000,000 ‚Ç´</option>
                            <option value="5000000+">Tr√™n 5,000,000 ‚Ç´</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="clearAllFilters()" style="background: #f0f0f0; color: #333; margin-right: 10px;">
                        üóëÔ∏è X√≥a t·∫•t c·∫£ b·ªô l·ªçc
                    </button>
                    <button class="btn" onclick="exportSearchResults()" style="background: linear-gradient(to right, #2196f3, #21cbf3); color: white;">
                        üì• Xu·∫•t k·∫øt qu·∫£ t√¨m ki·∫øm
                    </button>
                </div>
                
                <div id="searchResultsInfo" style="display: none; justify-content: space-between; align-items: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        <strong>üìä K·∫øt qu·∫£ t√¨m ki·∫øm:</strong>
                        <span id="resultsCount" style="margin-left: 10px; color: #2e7d32; font-weight: bold;">0 k·∫øt qu·∫£</span>
                    </div>
                    <button class="btn" onclick="clearSearch()" style="padding: 8px 15px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        X√≥a t√¨m ki·∫øm
                    </button>
                </div>
                
                <div id="searchResults">
                    <div class="loading">
                        <p>S·ª≠ d·ª•ng c√°c b·ªô l·ªçc ƒë·ªÉ t√¨m ki·∫øm d·ªØ li·ªáu...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="collapsible-section" id="exportSection">
            <div class="section-header" onclick="toggleExportSection()">
                <h3>üìÅ Xu·∫•t file b√°o c√°o</h3>
                <span>‚ñº</span>
            </div>
            <div class="section-content">
                <div class="export-options">
                    <div class="export-card">
                        <h4>üìä Xu·∫•t to√†n b·ªô d·ªØ li·ªáu</h4>
                        <p>Xu·∫•t t·∫•t c·∫£ d·ªØ li·ªáu sang file Excel</p>
                        <button class="btn" onclick="exportAllData()" style="margin-top: 15px; background: linear-gradient(to right, #4caf50, #8bc34a); color: white; width: 100%;">
                            üì• Xu·∫•t Excel
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <h4>üìÑ B√°o c√°o t·ªïng k·∫øt</h4>
                        <p>B√°o c√°o PDF v·ªõi bi·ªÉu ƒë·ªì v√† ph√¢n t√≠ch</p>
                        <button class="btn" onclick="exportSummaryReport()" style="margin-top: 15px; background: linear-gradient(to right, #f44336, #ef5350); color: white; width: 100%;">
                            üì• Xu·∫•t PDF
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <h4>üîç Xu·∫•t k·∫øt qu·∫£ t√¨m ki·∫øm</h4>
                        <p>Xu·∫•t k·∫øt qu·∫£ t√¨m ki·∫øm hi·ªán t·∫°i</p>
                        <button class="btn" onclick="exportSearchResults()" style="margin-top: 15px; background: linear-gradient(to right, #2196f3, #21cbf3); color: white; width: 100%;">
                            üì• Xu·∫•t Excel
                        </button>
                    </div>
                </div>
                
                <div class="progress-container" id="exportProgress">
                    <h4>üîÑ ƒêang xu·∫•t file...</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...</p>
                </div>
                
                <div class="data-info">
                    <h4>üëÅÔ∏è Xem tr∆∞·ªõc d·ªØ li·ªáu s·∫Ω xu·∫•t</h4>
                    <p>T·ªïng s·ªë d√≤ng: <span id="totalPreviewRows">0</span></p>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>ID</th>
                                    <th>Ng√†y</th>
                                    <th>N·ªôi dung</th>
                                    <th>Ph√≠ v·∫≠t t∆∞</th>
                                    <th>Ti·ªÅn c√¥ng</th>
                                    <th>T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody id="exportPreviewBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>H·ªá th·ªëng qu·∫£n l√Ω chi ph√≠ l√†m v∆∞·ªùn &copy; <span id="currentYearFooter">2024</span></p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                Google Sheet ID: <code id="sheetIdDisplay">1bVQzzwKmtqMwuCPUX0TJx9Fnsdbkuk57ncnX4HXU5v4</code> | 
                Sheet: <code>SR2526</code> | 
                T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 3 ph√∫t
            </p>
        </footer>
    </div>

    <script>
        // ============================
        // C·∫§U H√åNH H·ªÜ TH·ªêNG
        // ============================
        const SHEET_ID = '1bVQzzwKmtqMwuCPUX0TJx9Fnsdbkuk57ncnX4HXU5v4';
        const SHEET_NAME = 'SR2526';
        const AUTO_UPDATE_INTERVAL = 3 * 60 * 1000; // 3 ph√∫t
        const START_ROW = 3; // B·∫Øt ƒë·∫ßu t·ª´ h√†ng 3
        const API_KEY = 'AIzaSyC9Jw2CTp7pdnc2j6nO3h0zY3lK6U2B1Y0'; // API Key c√¥ng khai (ch·ªâ ƒë·ªçc)
        
        // Bi·∫øn h·ªá th·ªëng
        let updateCount = 0;
        let lastUpdateTime = null;
        let autoUpdateTimer = null;
        let countdownTimer = null;
        let countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
        let isDetailVisible = false;
        let isChartVisible = false;
        let isSearchVisible = false;
        let isExportVisible = false;
        let currentChartType = 'pie';
        
        // D·ªØ li·ªáu v√† bi·ªÉu ƒë·ªì
        let currentRows = [];
        let costChart = null;
        let workerChart = null;
        let trendChart = null;
        let currentFilteredRows = [];
        
        // ============================
        // KH·ªûI T·∫†O H·ªÜ TH·ªêNG
        // ============================
        
        // Kh·ªüi t·∫°o h·ªá th·ªëng
        function initSystem() {
            console.log('üîÑ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...');
            
            // C·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            document.getElementById('currentYearFooter').textContent = new Date().getFullYear();
            document.getElementById('sheetIdDisplay').textContent = SHEET_ID;
            
            // C·∫≠p nh·∫≠t th·ªùi gian th·ª±c
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // B·∫Øt ƒë·∫ßu countdown
            startCountdown();
            
            // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
            loadData();
            
            // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t
            startAutoUpdate();
            
            console.log('‚úÖ H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
        }
        
        // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
        function startCountdown() {
            countdownSeconds = AUTO_UPDATE_INTERVAL / 1000;
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                
                document.getElementById('countdownTimer').textContent = countdownSeconds;
                document.getElementById('nextUpdate').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    loadData();
                    startCountdown();
                }
            }, 1000);
        }
        
        // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t
        function startAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
            }
            
            autoUpdateTimer = setInterval(() => {
                loadData();
            }, AUTO_UPDATE_INTERVAL);
            
            document.getElementById('autoUpdateStatus').textContent = 'üü¢';
            document.getElementById('autoUpdateStatus').style.color = '#4CAF50';
        }
        
        // ============================
        // X·ª¨ L√ù D·ªÆ LI·ªÜU - S·ª¨ D·ª§NG GOOGLE SHEETS API V4
        // ============================
        
        // T·∫£i d·ªØ li·ªáu t·ª´ Google Sheet
        async function loadData() {
            try {
                console.log('üì• ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...');
                
                document.getElementById('connectionStatus').textContent = 'üîÑ ƒêang t·∫£i d·ªØ li·ªáu...';
                document.getElementById('connectionStatus').style.color = '#FF9800';
                document.getElementById('debugInfo').style.display = 'block';
                document.getElementById('debugInfo').innerHTML = '<small>ƒêang k·∫øt n·ªëi v·ªõi Google Sheets API...</small>';
                
                // PH∆Ø∆†NG PH√ÅP 1: S·ª≠ d·ª•ng Google Sheets API v4
                try {
                    const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                    
                    document.getElementById('debugInfo').innerHTML = `<small>ƒêang g·ªçi API: ${apiUrl.substring(0, 50)}...</small>`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.values && data.values.length > 0) {
                        currentRows = data.values;
                        processDataSuccess();
                        return;
                    } else {
                        throw new Error('Sheet tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu');
                    }
                    
                } catch (apiError) {
                    console.log('API method failed, trying CSV method...', apiError);
                    
                    // PH∆Ø∆†NG PH√ÅP 2: S·ª≠ d·ª•ng CSV export
                    try {
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                        document.getElementById('debugInfo').innerHTML = `<small>ƒêang th·ª≠ CSV: ${csvUrl.substring(0, 50)}...</small>`;
                        
                        const response = await fetch(csvUrl);
                        
                        if (!response.ok) {
                            throw new Error(`CSV Error: ${response.status}`);
                        }
                        
                        const csvText = await response.text();
                        currentRows = parseCSV(csvText);
                        processDataSuccess();
                        
                    } catch (csvError) {
                        console.log('CSV method failed, trying public access...', csvError);
                        
                        // PH∆Ø∆†NG PH√ÅP 3: Public access
                        try {
                            const publicUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?output=csv`;
                            document.getElementById('debugInfo').innerHTML = `<small>ƒêang th·ª≠ public access...</small>`;
                            
                            const response = await fetch(publicUrl);
                            
                            if (!response.ok) {
                                throw new Error(`Public Error: ${response.status}`);
                            }
                            
                            const csvText = await response.text();
                            currentRows = parseCSV(csvText);
                            processDataSuccess();
                            
                        } catch (publicError) {
                            console.log('All methods failed:', publicError);
                            throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Google Sheet');
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                
                // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u ƒë·ªÉ ki·ªÉm tra
                showSampleData();
                
                document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u';
                document.getElementById('connectionStatus').style.color = '#FF9800';
                document.getElementById('debugInfo').innerHTML = `<small>L·ªói: ${error.message}. ƒêang d√πng d·ªØ li·ªáu m·∫´u.</small>`;
                
                // Th·ª≠ l·∫°i sau 30 gi√¢y
                setTimeout(loadData, 30000);
            }
        }
        
        // X·ª≠ l√Ω d·ªØ li·ªáu th√†nh c√¥ng
        function processDataSuccess() {
            updateCount++;
            lastUpdateTime = new Date();
            
            document.getElementById('totalRows').textContent = currentRows.length;
            document.getElementById('updateCount').textContent = updateCount;
            document.getElementById('lastUpdateTime').textContent = 
                lastUpdateTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            // T√≠nh to√°n v√† hi·ªÉn th·ªã t·ªïng
            calculateAndDisplayTotals(currentRows);
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i
            document.getElementById('connectionStatus').textContent = `‚úÖ ƒê√£ t·∫£i ${currentRows.length} h√†ng`;
            document.getElementById('connectionStatus').style.color = '#4CAF50';
            document.getElementById('debugInfo').innerHTML = `<small>Th√†nh c√¥ng! ${currentRows.length} h√†ng d·ªØ li·ªáu.</small>`;
            
            document.getElementById('lastUpdate').textContent = 
                lastUpdateTime.toLocaleString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            
            // C·∫≠p nh·∫≠t c√°c ph·∫ßn hi·ªÉn th·ªã n·∫øu ƒëang m·ªü
            if (isDetailVisible) {
                displayDetailTable(currentRows);
            }
            
            if (isChartVisible) {
                updateCharts(currentRows);
            }
            
            if (isSearchVisible) {
                filterTable();
            }
            
            if (isExportVisible) {
                updateExportPreview();
            }
            
            console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu l·∫ßn ${updateCount} (${currentRows.length} h√†ng)`);
        }
        
        // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u ƒë·ªÉ ki·ªÉm tra
        function showSampleData() {
            currentRows = [
                ["ID", "Ng√†y", "N·ªôi dung", "Ph√≠ v·∫≠t t∆∞", "Ti·ªÅn c√¥ng", "", "Tri·ªÅu", "T√®o", "Thi·ªán", "Thu·∫≠n"],
                ["Ti√™u ƒë·ªÅ", "Date", "Description", "Material", "Labor", "", "Worker1", "Worker2", "Worker3", "Worker4"],
                ["1", "01/01/2024", "Mua ph√¢n b√≥n", "500000", "300000", "", "150000", "150000", "0", "0"],
                ["2", "02/01/2024", "Thu√™ m√°y c√†y", "0", "1000000", "", "500000", "500000", "0", "0"],
                ["3", "03/01/2024", "Mua c√¢y gi·ªëng", "800000", "200000", "", "100000", "100000", "0", "0"],
                ["4", "04/01/2024", "L√†m c·ªè", "0", "600000", "", "200000", "200000", "200000", "0"],
                ["5", "05/01/2024", "T∆∞·ªõi ti√™u", "300000", "400000", "", "100000", "100000", "100000", "100000"]
            ];
            
            calculateAndDisplayTotals(currentRows);
            
            // C·∫≠p nh·∫≠t c√°c ph·∫ßn hi·ªÉn th·ªã
            if (isDetailVisible) displayDetailTable(currentRows);
            if (isChartVisible) updateCharts(currentRows);
            if (isSearchVisible) filterTable();
            if (isExportVisible) updateExportPreview();
        }
        
        // Ph√¢n t√≠ch CSV
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // X·ª≠ l√Ω d·∫•u ngo·∫∑c k√©p v√† d·∫•u ph·∫©y trong tr∆∞·ªùng
                    const row = [];
                    let inQuotes = false;
                    let field = '';
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(field);
                            field = '';
                        } else {
                            field += char;
                        }
                    }
                    
                    row.push(field);
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // ƒê·ªãnh d·∫°ng ti·ªÅn Vi·ªát Nam
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value) || value === 0) {
                return '0 ‚Ç´';
            }
            
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Hi·ªÉn th·ªã s·ªë ti·ªÅn
        function displayAmount(value) {
            if (!value && value !== 0) return '0 ‚Ç´';
            
            if (typeof value === 'string') {
                // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë, tr·ª´ d·∫•u ch·∫•m v√† d·∫•u ph·∫©y
                const cleanValue = value.replace(/[^\d.,]/g, '');
                if (!cleanValue) return '0 ‚Ç´';
                
                // Chuy·ªÉn ƒë·ªïi sang s·ªë
                const num = parseFloat(cleanValue.replace(/\./g, '').replace(',', '.'));
                return isNaN(num) ? '0 ‚Ç´' : formatCurrency(num);
            }
            
            return formatCurrency(value);
        }
        
        // Chuy·ªÉn ƒë·ªïi s·ªë t·ª´ Google Sheet
        function parseSheetNumber(value) {
            if (!value && value !== 0) return 0;
            
            if (typeof value === 'string') {
                const cleanValue = value.replace(/[^\d.,-]/g, '');
                if (!cleanValue) return 0;
                
                const num = parseFloat(cleanValue.replace(/\./g, '').replace(',', '.'));
                return isNaN(num) ? 0 : num;
            }
            
            return parseFloat(value) || 0;
        }
        
        // T√≠nh to√°n v√† hi·ªÉn th·ªã t·ªïng
        function calculateAndDisplayTotals(rows) {
            let totalVatTu = 0;
            let totalTienCong = 0;
            let totalTrieu = 0;
            let totalTeo = 0;
            let totalThien = 0;
            let totalThuan = 0;
            
            let dataRowsCount = 0;
            
            // B·∫Øt ƒë·∫ßu t·ª´ START_ROW (h√†ng th·ª© 3)
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 5) {
                    dataRowsCount++;
                    
                    totalVatTu += parseSheetNumber(row[3]);
                    totalTienCong += parseSheetNumber(row[4]);
                    
                    // C√°c c·ªôt c√¥ng nh√¢n (b·∫Øt ƒë·∫ßu t·ª´ c·ªôt 6)
                    if (row.length > 6) totalTrieu += parseSheetNumber(row[6]);
                    if (row.length > 7) totalTeo += parseSheetNumber(row[7]);
                    if (row.length > 8) totalThien += parseSheetNumber(row[8]);
                    if (row.length > 9) totalThuan += parseSheetNumber(row[9]);
                }
            }
            
            const totalChiPhi = totalVatTu + totalTienCong;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('totalChiPhi').textContent = formatCurrency(totalChiPhi);
            document.getElementById('totalVatTu').textContent = formatCurrency(totalVatTu);
            document.getElementById('totalTienCong').textContent = formatCurrency(totalTienCong);
            document.getElementById('totalTrieu').textContent = formatCurrency(totalTrieu);
            document.getElementById('totalTeo').textContent = formatCurrency(totalTeo);
            document.getElementById('totalThien').textContent = formatCurrency(totalThien);
            document.getElementById('totalThuan').textContent = formatCurrency(totalThuan);
            
            document.getElementById('dataRows').textContent = dataRowsCount;
            
            console.log('üìä T·ªïng k·∫øt:', {
                'T·ªïng h√†ng': dataRowsCount,
                'T·ªïng chi ph√≠': formatCurrency(totalChiPhi),
                'Ph√≠ v·∫≠t t∆∞': formatCurrency(totalVatTu),
                'Ti·ªÅn c√¥ng': formatCurrency(totalTienCong)
            });
        }
        
        // ============================
        // C√ÅC CH·ª®C NƒÇNG KH√ÅC (GI·ªÆ NGUY√äN)
        // ============================
        
        // Hi·ªÉn th·ªã/·∫©n chi ti·∫øt
        function toggleDetail() {
            const detailSection = document.getElementById('detailSection');
            const detailButton = document.getElementById('detailButtonText');
            
            isDetailVisible = !isDetailVisible;
            
            if (isDetailVisible) {
                detailSection.style.display = 'block';
                detailButton.textContent = '·∫®n chi ti·∫øt';
                displayDetailTable(currentRows);
            } else {
                detailSection.style.display = 'none';
                detailButton.textContent = 'üìã Xem chi ti·∫øt d·ªØ li·ªáu';
            }
        }
        
        // Hi·ªÉn th·ªã b·∫£ng chi ti·∫øt
        function displayDetailTable(rows) {
            const detailContent = document.getElementById('detailContent');
            
            if (!rows || rows.length === 0) {
                detailContent.innerHTML = '<div class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>ID</th>
                                <th>Ng√†y</th>
                                <th>N·ªôi dung</th>
                                <th>Ph√≠ v·∫≠t t∆∞</th>
                                <th>Ti·ªÅn c√¥ng</th>
                                <th>Tri·ªÅu</th>
                                <th>T√®o</th>
                                <th>Thi·ªán</th>
                                <th>Thu·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let displayedCount = 0;
            
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 5) {
                    const rowNumber = i + 1;
                    
                    html += `
                        <tr>
                            <td>${rowNumber}</td>
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${row[2] || ''}</td>
                            <td>${displayAmount(row[3])}</td>
                            <td>${displayAmount(row[4])}</td>
                            <td>${row.length > 6 ? displayAmount(row[6]) : '0 ‚Ç´'}</td>
                            <td>${row.length > 7 ? displayAmount(row[7]) : '0 ‚Ç´'}</td>
                            <td>${row.length > 8 ? displayAmount(row[8]) : '0 ‚Ç´'}</td>
                            <td>${row.length > 9 ? displayAmount(row[9]) : '0 ‚Ç´'}</td>
                        </tr>
                    `;
                    displayedCount++;
                }
            }
            
            html += `
                        </tbody>
                    </table>
                    <div class="data-info">
                        <p><strong>üìà Th·ªëng k√™ chi ti·∫øt:</strong></p>
                        <p>T·ªïng s·ªë h√†ng: ${displayedCount}</p>
                        <p>Th·ªùi gian: ${new Date().toLocaleTimeString('vi-VN')}</p>
                    </div>
                </div>
            `;
            
            detailContent.innerHTML = html;
            document.getElementById('loadingDetail').style.display = 'none';
        }
        
        // Hi·ªÉn th·ªã/·∫©n bi·ªÉu ƒë·ªì
        function toggleChartSection() {
            const chartSection = document.getElementById('chartSection');
            const sectionContent = chartSection.querySelector('.section-content');
            const chartButton = document.getElementById('chartButtonText');
            
            isChartVisible = !isChartVisible;
            
            if (isChartVisible) {
                sectionContent.classList.add('active');
                chartButton.textContent = '·∫®n bi·ªÉu ƒë·ªì';
                updateCharts(currentRows);
            } else {
                sectionContent.classList.remove('active');
                chartButton.textContent = 'üìä Xem bi·ªÉu ƒë·ªì';
            }
        }
        
        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
        function updateCharts(rows) {
            if (!rows || rows.length === 0) {
                // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                document.getElementById('costDistributionChart').parentElement.innerHTML = '<p class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì</p>';
                document.getElementById('workerChart').parentElement.innerHTML = '<p class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì</p>';
                document.getElementById('trendChart').parentElement.innerHTML = '<p class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì</p>';
                return;
            }
            
            // X√≥a bi·ªÉu ƒë·ªì c≈©
            if (costChart) costChart.destroy();
            if (workerChart) workerChart.destroy();
            if (trendChart) trendChart.destroy();
            
            // T·∫°o bi·ªÉu ƒë·ªì m·ªõi
            createCostDistributionChart(rows);
            createWorkerChart(rows);
            createTrendChart(rows);
        }
        
        // T·∫°o bi·ªÉu ƒë·ªì ph√¢n b·ªï chi ph√≠
        function createCostDistributionChart(rows) {
            const ctx = document.getElementById('costDistributionChart').getContext('2d');
            
            let totalVatTu = 0;
            let totalTienCong = 0;
            
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 5) {
                    totalVatTu += parseSheetNumber(row[3]);
                    totalTienCong += parseSheetNumber(row[4]);
                }
            }
            
            const data = {
                labels: ['Ph√≠ v·∫≠t t∆∞', 'Ti·ªÅn c√¥ng'],
                datasets: [{
                    data: [totalVatTu, totalTienCong],
                    backgroundColor: ['#4CAF50', '#2196F3'],
                    borderWidth: 2
                }]
            };
            
            costChart = new Chart(ctx, {
                type: currentChartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${formatCurrency(context.raw)}`
                            }
                        }
                    }
                }
            });
            
            // T·∫°o legend
            document.getElementById('costChartLegend').innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50;"></div>
                    <span>Ph√≠ v·∫≠t t∆∞: ${formatCurrency(totalVatTu)}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2196F3;"></div>
                    <span>Ti·ªÅn c√¥ng: ${formatCurrency(totalTienCong)}</span>
                </div>
            `;
        }
        
        // T·∫°o bi·ªÉu ƒë·ªì ti·ªÅn c√¥ng theo c√¥ng nh√¢n
        function createWorkerChart(rows) {
            const ctx = document.getElementById('workerChart').getContext('2d');
            
            const workerTotals = {
                'Tri·ªÅu': 0,
                'T√®o': 0,
                'Thi·ªán': 0,
                'Thu·∫≠n': 0
            };
            
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length >= 7) {
                    if (row.length > 6) workerTotals['Tri·ªÅu'] += parseSheetNumber(row[6]);
                    if (row.length > 7) workerTotals['T√®o'] += parseSheetNumber(row[7]);
                    if (row.length > 8) workerTotals['Thi·ªán'] += parseSheetNumber(row[8]);
                    if (row.length > 9) workerTotals['Thu·∫≠n'] += parseSheetNumber(row[9]);
                }
            }
            
            const data = {
                labels: Object.keys(workerTotals),
                datasets: [{
                    label: 'Ti·ªÅn c√¥ng',
                    data: Object.values(workerTotals),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    borderWidth: 2
                }]
            };
            
            workerChart = new Chart(ctx, {
                type: currentChartType === 'line' ? 'bar' : currentChartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${formatCurrency(context.raw)}`
                            }
                        }
                    }
                }
            });
            
            // T·∫°o legend
            let legendHtml = '';
            Object.entries(workerTotals).forEach(([worker, total], index) => {
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[index]}"></div>
                        <span>${worker}: ${formatCurrency(total)}</span>
                    </div>
                `;
            });
            
            document.getElementById('workerChartLegend').innerHTML = legendHtml;
        }
        
        // T·∫°o bi·ªÉu ƒë·ªì xu h∆∞·ªõng
        function createTrendChart(rows) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Nh√≥m d·ªØ li·ªáu theo th√°ng
            const monthlyData = {};
            
            for (let i = Math.max(START_ROW - 1, 0); i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 5) continue;
                
                const dateStr = row[1];
                const vatTu = parseSheetNumber(row[3]);
                const tienCong = parseSheetNumber(row[4]);
                
                if (dateStr) {
                    const dateParts = dateStr.split('/');
                    if (dateParts.length >= 2) {
                        const month = parseInt(dateParts[1]);
                        const year = dateParts.length === 3 ? dateParts[2] : new Date().getFullYear();
                        const key = `Th√°ng ${month}/${year}`;
                        
                        if (!monthlyData[key]) {
                            monthlyData[key] = { vatTu: 0, tienCong: 0 };
                        }
                        
                        monthlyData[key].vatTu += vatTu;
                        monthlyData[key].tienCong += tienCong;
                    }
                }
            }
            
            // S·∫Øp x·∫øp theo th·ªùi gian
            const sortedKeys = Object.keys(monthlyData).sort((a, b) => {
                const [aMonth, aYear] = a.match(/\d+/g).map(Number);
                const [bMonth, bYear] = b.match(/\d+/g).map(Number);
                if (aYear !== bYear) return aYear - bYear;
                return aMonth - bMonth;
            });
            
            if (sortedKeys.length === 0) {
                document.getElementById('trendChart').parentElement.innerHTML = '<p class="no-results">Kh√¥ng c√≥ d·ªØ li·ªáu theo th·ªùi gian</p>';
                return;
            }
            
            const labels = sortedKeys;
            const vatTuData = sortedKeys.map(key => monthlyData[key].vatTu);
            const tienCongData = sortedKeys.map(key => monthlyData[key].tienCong);
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ph√≠ v·∫≠t t∆∞',
                            data: vatTuData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Ti·ªÅn c√¥ng',
                            data: tienCongData,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value).replace('‚Ç´', '')
                            }
                        }
                    }
                }
            });
        }
        
        // C√°c h√†m kh√°c gi·ªØ nguy√™n t·ª´ code tr∆∞·ªõc...
        // (C√°c h√†m filterTable, displaySearchResults, export functions, etc.)
        
        // ============================
        // KH·ªûI CH·∫†Y H·ªÜ TH·ªêNG
        // ============================
        
        // Kh·ªüi ch·∫°y khi trang ƒë√£ t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Trang ƒë√£ s·∫µn s√†ng, ƒëang kh·ªüi t·∫°o h·ªá th·ªëng...');
            initSystem();
        });
        
        // Cho ph√©p refresh b·∫±ng F5
        document.addEventListener('keydown', function(event) {
            if (event.key === 'F5') {
                event.preventDefault();
                loadData();
            }
        });
        
        // X·ª≠ l√Ω l·ªói to√†n c·ª•c
        window.addEventListener('error', function(event) {
            console.error('L·ªói h·ªá th·ªëng:', event.error);
            document.getElementById('connectionStatus').textContent = '‚ùå L·ªói h·ªá th·ªëng';
            document.getElementById('connectionStatus').style.color = '#f44336';
        });
        
        // ============================
        // C√ÅC H√ÄM C√íN L·∫†I (GI·ªÆ NGUY√äN T·ª™ CODE TR∆Ø·ªöC)
        // ============================
        
        // Thay ƒë·ªïi lo·∫°i bi·ªÉu ƒë·ªì
        function changeChartType(type) {
            currentChartType = type;
            updateCharts(currentRows);
        }
        
        // Hi·ªÉn th·ªã/·∫©n ph·∫ßn t√¨m ki·∫øm
        function toggleSearchSection() {
            const searchSection = document.getElementById('searchSection');
            const sectionContent = searchSection.querySelector('.section-content');
            const searchButton = document.getElementById('searchButtonText');
            
            isSearchVisible = !isSearchVisible;
            
            if (isSearchVisible) {
                sectionContent.classList.add('active');
                searchButton.textContent = '·∫®n t√¨m ki·∫øm';
                filterTable();
            } else {
                sectionContent.classList.remove('active');
                searchButton.textContent = 'üîç T√¨m ki·∫øm & L·ªçc';
            }
        }
        
        // L·ªçc b·∫£ng
        function filterTable() {
            if (!currentRows || currentRows.length === 0) return;
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const worker = document.getElementById('workerFilter').value;
            const amount = document.getElementById('amountFilter').value;
            
            const filtered = [];
            
            for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
                const row = currentRows[i];
                if (!row || row.length < 5) continue;
                
                let match = true;
                
                // L·ªçc theo t·ª´ kh√≥a
                if (searchTerm) {
                    const rowText = (row[0] + ' ' + row[1] + ' ' + row[2]).toLowerCase();
                    if (!rowText.includes(searchTerm)) {
                        match = false;
                    }
                }
                
                // L·ªçc theo danh m·ª•c
                if (match && category) {
                    const vatTu = parseSheetNumber(row[3]);
                    const tienCong = parseSheetNumber(row[4]);
                    
                    if (category === 'vat_tu' && vatTu === 0) match = false;
                    if (category === 'tien_cong' && tienCong === 0) match = false;
                }
                
                // L·ªçc theo c√¥ng nh√¢n
                if (match && worker) {
                    let workerAmount = 0;
                    switch(worker) {
                        case 'Tri·ªÅu': workerAmount = row.length > 6 ? parseSheetNumber(row[6]) : 0; break;
                        case 'T√®o': workerAmount = row.length > 7 ? parseSheetNumber(row[7]) : 0; break;
                        case 'Thi·ªán': workerAmount = row.length > 8 ? parseSheetNumber(row[8]) : 0; break;
                        case 'Thu·∫≠n': workerAmount = row.length > 9 ? parseSheetNumber(row[9]) : 0; break;
                    }
                    if (workerAmount === 0) match = false;
                }
                
                // L·ªçc theo m·ª©c chi ph√≠
                if (match && amount) {
                    const total = parseSheetNumber(row[3]) + parseSheetNumber(row[4]);
                    
                    switch(amount) {
                        case '0-500000': if (total >= 500000) match = false; break;
                        case '500000-1000000': if (total < 500000 || total >= 1000000) match = false; break;
                        case '1000000-5000000': if (total < 1000000 || total >= 5000000) match = false; break;
                        case '5000000+': if (total < 5000000) match = false; break;
                    }
                }
                
                if (match) {
                    filtered.push({ index: i, row: row });
                }
            }
            
            currentFilteredRows = filtered;
            displaySearchResults(filtered);
        }
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
        function displaySearchResults(filtered) {
            const searchResults = document.getElementById('searchResults');
            const resultsInfo = document.getElementById('searchResultsInfo');
            const resultsCount = document.getElementById('resultsCount');
            
            if (filtered.length === 0) {
                searchResults.innerHTML = '<div class="no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</div>';
                resultsInfo.style.display = 'none';
                return;
            }
            
            resultsInfo.style.display = 'flex';
            resultsCount.textContent = `${filtered.length} k·∫øt qu·∫£`;
            
            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>ID</th>
                                <th>Ng√†y</th>
                                <th>N·ªôi dung</th>
                                <th>Ph√≠ v·∫≠t t∆∞</th>
                                <th>Ti·ªÅn c√¥ng</th>
                                <th>T·ªïng</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalVatTu = 0, totalTienCong = 0, totalAll = 0;
            
            filtered.forEach((item, idx) => {
                const row = item.row;
                const vatTu = parseSheetNumber(row[3]);
                const tienCong = parseSheetNumber(row[4]);
                const total = vatTu + tienCong;
                
                totalVatTu += vatTu;
                totalTienCong += tienCong;
                totalAll += total;
                
                html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${row[0] || ''}</td>
                        <td>${row[1] || ''}</td>
                        <td>${row[2] || ''}</td>
                        <td>${formatCurrency(vatTu)}</td>
                        <td>${formatCurrency(tienCong)}</td>
                        <td><strong>${formatCurrency(total)}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot style="background-color: #f5f5f5; font-weight: bold;">
                            <tr>
                                <td colspan="4" style="text-align: right;">T·ªïng (${filtered.length} h√†ng):</td>
                                <td>${formatCurrency(totalVatTu)}</td>
                                <td>${formatCurrency(totalTienCong)}</td>
                                <td>${formatCurrency(totalAll)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            searchResults.innerHTML = html;
        }
        
        // X√≥a t√¨m ki·∫øm
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterTable();
        }
        
        // X√≥a t·∫•t c·∫£ b·ªô l·ªçc
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('workerFilter').value = '';
            document.getElementById('amountFilter').value = '';
            filterTable();
        }
        
        // Hi·ªÉn th·ªã/·∫©n ph·∫ßn xu·∫•t file
        function toggleExportSection() {
            const exportSection = document.getElementById('exportSection');
            const sectionContent = exportSection.querySelector('.section-content');
            const exportButton = document.getElementById('exportButtonText');
            
            isExportVisible = !isExportVisible;
            
            if (isExportVisible) {
                sectionContent.classList.add('active');
                exportButton.textContent = '·∫®n xu·∫•t file';
                updateExportPreview();
            } else {
                sectionContent.classList.remove('active');
                exportButton.textContent = 'üìÅ Xu·∫•t file';
            }
        }
        
        // C·∫≠p nh·∫≠t preview xu·∫•t file
        function updateExportPreview() {
            const totalRows = Math.max(0, currentRows.length - START_ROW + 1);
            document.getElementById('totalPreviewRows').textContent = totalRows;
            
            const previewBody = document.getElementById('exportPreviewBody');
            
            if (totalRows <= 0) {
                previewBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            let html = '';
            const limit = Math.min(5, totalRows);
            
            for (let i = 0; i < limit; i++) {
                const rowIndex = START_ROW - 1 + i;
                const row = currentRows[rowIndex];
                if (row && row.length >= 5) {
                    const vatTu = parseSheetNumber(row[3]);
                    const tienCong = parseSheetNumber(row[4]);
                    const total = vatTu + tienCong;
                    
                    html += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${(row[2] || '').substring(0, 30)}${(row[2] || '').length > 30 ? '...' : ''}</td>
                            <td>${formatCurrency(vatTu)}</td>
                            <td>${formatCurrency(tienCong)}</td>
                            <td>${formatCurrency(total)}</td>
                        </tr>
                    `;
                }
            }
            
            previewBody.innerHTML = html;
        }
        
        // Xu·∫•t to√†n b·ªô d·ªØ li·ªáu
        async function exportAllData() {
            try {
                if (!currentRows || currentRows.length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                    return;
                }
                
                showExportProgress();
                updateExportProgress(10, 'ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...');
                
                // T·∫°o d·ªØ li·ªáu cho Excel
                const data = [
                    ['STT', 'ID', 'Ng√†y', 'N·ªôi dung', 'Ph√≠ v·∫≠t t∆∞', 'Ti·ªÅn c√¥ng', 'Tri·ªÅu', 'T√®o', 'Thi·ªán', 'Thu·∫≠n', 'T·ªïng']
                ];
                
                updateExportProgress(30, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...');
                
                let totalVatTu = 0, totalTienCong = 0, totalAll = 0;
                let idx = 0;
                
                for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
                    const row = currentRows[i];
                    if (row && row.length >= 5) {
                        idx++;
                        const vatTu = parseSheetNumber(row[3]);
                        const tienCong = parseSheetNumber(row[4]);
                        const total = vatTu + tienCong;
                        
                        totalVatTu += vatTu;
                        totalTienCong += tienCong;
                        totalAll += total;
                        
                        data.push([
                            idx,
                            row[0] || '',
                            row[1] || '',
                            row[2] || '',
                            vatTu,
                            tienCong,
                            row.length > 6 ? parseSheetNumber(row[6]) : 0,
                            row.length > 7 ? parseSheetNumber(row[7]) : 0,
                            row.length > 8 ? parseSheetNumber(row[8]) : 0,
                            row.length > 9 ? parseSheetNumber(row[9]) : 0,
                            total
                        ]);
                    }
                }
                
                // Th√™m t·ªïng k·∫øt
                data.push([]);
                data.push(['T·ªîNG K·∫æT', '', '', '', '', '', '', '', '', '', '']);
                data.push(['T·ªïng ph√≠ v·∫≠t t∆∞:', '', '', '', totalVatTu, '', '', '', '', '', '']);
                data.push(['T·ªïng ti·ªÅn c√¥ng:', '', '', '', '', totalTienCong, '', '', '', '', '']);
                data.push(['T·ªïng chi ph√≠:', '', '', '', '', '', '', '', '', '', totalAll]);
                
                updateExportProgress(70, 'ƒêang t·∫°o file Excel...');
                
                // T·∫°o workbook
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Chi ph√≠ l√†m v∆∞·ªùn");
                
                updateExportProgress(90, 'ƒêang t·∫£i file xu·ªëng...');
                
                // Xu·∫•t file
                const fileName = `Chi_phi_lam_vuon_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                updateExportProgress(100, 'Xu·∫•t file th√†nh c√¥ng!');
                setTimeout(hideExportProgress, 1000);
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t Excel:', error);
                alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t file');
                hideExportProgress();
            }
        }
        
        // Xu·∫•t b√°o c√°o PDF
        async function exportSummaryReport() {
            try {
                if (!currentRows || currentRows.length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                    return;
                }
                
                showExportProgress();
                updateExportProgress(20, 'ƒêang t·∫°o b√°o c√°o...');
                
                // T·∫°o PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Ti√™u ƒë·ªÅ
                doc.setFontSize(20);
                doc.text('B√ÅO C√ÅO CHI PH√ç L√ÄM V∆Ø·ªúN', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`, 105, 30, { align: 'center' });
                
                // T√≠nh t·ªïng
                let totalVatTu = 0, totalTienCong = 0, totalAll = 0;
                let dataCount = 0;
                
                for (let i = Math.max(START_ROW - 1, 0); i < currentRows.length; i++) {
                    const row = currentRows[i];
                    if (row && row.length >= 5) {
                        dataCount++;
                        totalVatTu += parseSheetNumber(row[3]);
                        totalTienCong += parseSheetNumber(row[4]);
                    }
                }
                
                totalAll = totalVatTu + totalTienCong;
                
                // Th√¥ng tin t·ªïng quan
                doc.setFontSize(14);
                doc.text('T·ªîNG QUAN CHI PH√ç', 20, 50);
                
                doc.setFontSize(11);
                doc.text(`T·ªïng s·ªë h·∫°ng m·ª•c: ${dataCount}`, 20, 65);
                doc.text(`T·ªïng chi ph√≠: ${formatCurrency(totalAll)}`, 20, 75);
                doc.text(`Ph√≠ v·∫≠t t∆∞: ${formatCurrency(totalVatTu)}`, 20, 85);
                doc.text(`Ti·ªÅn c√¥ng: ${formatCurrency(totalTienCong)}`, 20, 95);
                
                updateExportProgress(60, 'ƒêang l∆∞u file...');
                
                // L∆∞u file
                const fileName = `Bao_cao_chi_phi_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
                
                updateExportProgress(100, 'Xu·∫•t file th√†nh c√¥ng!');
                setTimeout(hideExportProgress, 1000);
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t PDF:', error);
                alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t file');
                hideExportProgress();
            }
        }
        
        // Xu·∫•t k·∫øt qu·∫£ t√¨m ki·∫øm
        async function exportSearchResults() {
            try {
                if (!currentFilteredRows || currentFilteredRows.length === 0) {
                    alert('Kh√¥ng c√≥ k·∫øt qu·∫£ t√¨m ki·∫øm ƒë·ªÉ xu·∫•t');
                    return;
                }
                
                showExportProgress();
                updateExportProgress(10, 'ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...');
                
                // T·∫°o d·ªØ li·ªáu Excel
                const data = [
                    ['STT', 'ID', 'Ng√†y', 'N·ªôi dung', 'Ph√≠ v·∫≠t t∆∞', 'Ti·ªÅn c√¥ng', 'T·ªïng']
                ];
                
                updateExportProgress(40, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...');
                
                currentFilteredRows.forEach((item, idx) => {
                    const row = item.row;
                    const vatTu = parseSheetNumber(row[3]);
                    const tienCong = parseSheetNumber(row[4]);
                    const total = vatTu + tienCong;
                    
                    data.push([
                        idx + 1,
                        row[0] || '',
                        row[1] || '',
                        row[2] || '',
                        vatTu,
                        tienCong,
                        total
                    ]);
                });
                
                updateExportProgress(80, 'ƒêang t·∫°o file...');
                
                // T·∫°o workbook
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "K·∫øt qu·∫£ t√¨m ki·∫øm");
                
                // Xu·∫•t file
                const fileName = `Ket_qua_tim_kiem_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                updateExportProgress(100, 'Xu·∫•t file th√†nh c√¥ng!');
                setTimeout(hideExportProgress, 1000);
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t k·∫øt qu·∫£ t√¨m ki·∫øm:', error);
                alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t file');
                hideExportProgress();
            }
        }
        
        // Hi·ªÉn th·ªã thanh ti·∫øn tr√¨nh
        function showExportProgress() {
            document.getElementById('exportProgress').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'ƒêang chu·∫©n b·ªã...';
        }
        
        // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
        function updateExportProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }
        
        // ·∫®n thanh ti·∫øn tr√¨nh
        function hideExportProgress() {
            setTimeout(() => {
                document.getElementById('exportProgress').style.display = 'none';
            }, 500);
        }
    </script>
</body>
</html>
