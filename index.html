<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Chi Ph√≠ SR2526 - Dashboard Ho√†n Ch·ªânh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-size: 0.9rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: 0.3s; }
        .card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.12); }
        .money { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; }
        .money-input { text-align: right; font-weight: bold; color: #0d6efd; }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        .stat-label { font-size: 0.75rem; color: #6c757d; font-weight: bold; text-transform: uppercase; }
        .table thead { background-color: #212529; color: white; }
        .action-btn { padding: 2px 8px; border-radius: 6px; }
        .system-info { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container py-3">
    <!-- Th√¥ng tin h·ªá th·ªëng -->
    <div class="system-info mb-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-1"><i class="fas fa-leaf text-success"></i> Qu·∫£n L√Ω Chi Ph√≠ SR2526</h5>
                <small class="text-muted">T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 3 ph√∫t | C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdate">--:--</span></small>
            </div>
            <div class="col-md-6 text-end">
                <span class="status-badge" id="connectionStatus">üîÑ ƒêang k·∫øt n·ªëi...</span>
                <button class="btn btn-sm btn-primary ms-2" onclick="loadData()">
                    <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                </button>
            </div>
        </div>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card p-3 text-center border-start border-primary border-4">
                <div class="stat-label">T·ªîNG CHI PH√ç</div>
                <div class="h4 text-primary fw-bold mb-0" id="tTotal">0ƒë</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center border-start border-info border-4">
                <div class="stat-label">TI·ªÄN V·∫¨T T∆Ø</div>
                <div class="h4 text-info fw-bold mb-0" id="tVatTu">0ƒë</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center border-start border-warning border-4">
                <div class="stat-label">TI·ªÄN C√îNG</div>
                <div class="h4 text-warning fw-bold mb-0" id="tTienCong">0ƒë</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center border-start border-success border-4">
                <div class="stat-label">S·ªê H√ÄNG D·ªÆ LI·ªÜU</div>
                <div class="h4 text-success fw-bold mb-0" id="totalRows">0</div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="row g-3 mb-3">
        <div class="col-md-5">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">T·ª∂ L·ªÜ CHI PH√ç</h6>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card p-3 h-100">
                <h6 class="fw-bold text-center border-bottom pb-2 mb-3">L∆Ø∆†NG NH√ÇN VI√äN T√çCH L≈®Y</h6>
                <div class="chart-wrapper">
                    <canvas id="staffChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-list-alt text-primary"></i> NH·∫¨T K√ù CHI PH√ç</h6>
            <button class="btn btn-success btn-sm fw-bold px-3 shadow-sm" onclick="openModal('add')">
                <i class="fas fa-plus-circle"></i> TH√äM M·ªöI
            </button>
        </div>
        <div class="table-responsive">
            <table id="tbl" class="table table-sm table-hover w-100 border">
                <thead>
                    <tr>
                        <th class="text-center">ID</th>
                        <th>Ng√†y</th>
                        <th>N·ªôi dung</th>
                        <th class="text-end">V·∫≠t t∆∞</th>
                        <th class="text-end">C√¥ng</th>
                        <th class="text-center">X·ª≠ l√Ω</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal th√™m/s·ª≠a -->
<div class="modal fade" id="modal" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white p-2 px-3">
                <h6 class="modal-title" id="mTitle">Nh·∫≠p li·ªáu</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="row g-2 mb-2">
                    <div class="col-4"><label class="small fw-bold">Ng√†y (*)</label><input type="date" id="date" class="form-control form-control-sm"></div>
                    <div class="col-8"><label class="small fw-bold">N·ªôi dung c√¥ng vi·ªác (*)</label><input id="content" class="form-control form-control-sm" placeholder="V√≠ d·ª•: Mua s∆°n, tr·∫£ l∆∞∆°ng tu·∫ßn..."></div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold text-info">Ti·ªÅn V·∫≠t t∆∞</label><input id="vatTu" class="form-control form-control-sm money-input" value="0"></div>
                    <div class="col-6"><label class="small fw-bold text-warning">Ti·ªÅn c√¥ng th·ª£</label><input id="tienCong" class="form-control form-control-sm money-input" value="0"></div>
                </div>
                <div class="p-2 border rounded bg-light mb-2">
                    <small class="text-muted fw-bold d-block mb-2"><i class="fas fa-users"></i> CHI TI·∫æT CHIA L∆Ø∆†NG:</small>
                    <div class="row g-1 text-center">
                        <div class="col-3"><label class="small">Tri·ªÅu</label><input id="trieu" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">T√®o</label><input id="teo" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">Thi·ªán</label><input id="thien" class="form-control form-control-sm money-input" value="0"></div>
                        <div class="col-3"><label class="small">Thu·∫≠n</label><input id="thuan" class="form-control form-control-sm money-input" value="0"></div>
                    </div>
                </div>
                <div class="mb-3"><label class="small fw-bold">Ghi ch√∫ th√™m</label><input id="note" class="form-control form-control-sm"></div>
                
                <div id="saveLoading" class="text-center d-none mb-2">
                    <div class="spinner-border spinner-border-sm text-primary"></div> <small class="text-primary">ƒêang l∆∞u v√† g·ª≠i email th√¥ng b√°o...</small>
                </div>
                <button id="saveBtn" class="btn btn-primary w-100 fw-bold py-2 shadow-sm" onclick="save()">L∆ØU TH√îNG TIN</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c th·ª±c -->
<div class="modal fade" id="loginModal">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-danger"><i class="fas fa-user-shield fa-3x"></i></div>
                <h6 class="fw-bold mb-1">X√ÅC TH·ª∞C QU·∫¢N TR·ªä</h6>
                <p class="small text-muted mb-3" id="authTxt"></p>
                <input type="password" id="authPass" class="form-control text-center mb-3" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
                <div id="authLoading" class="spinner-border spinner-border-sm text-primary d-none mb-2"></div>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger fw-bold" onclick="confirmAuth()">X√ÅC NH·∫¨N</button>
                    <button class="btn btn-light btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    // ========================================
    // C·∫§U H√åNH - THAY ƒê·ªîI URL N√ÄY SAU KHI DEPLOY APPS SCRIPT
    // ========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID_HERE/exec';
    
    // ========================================
    // BI·∫æN TO√ÄN C·ª§C
    // ========================================
    let currentData = [], currentAction = '', targetId = '', tempSave = {};
    let costChart, staffChart;
    const money = n => Number(n).toLocaleString("vi-VN");
    const unMoney = v => Number(String(v).replace(/[^0-9-]/g, "")) || 0;

    // ========================================
    // H√ÄM G·ªåI API
    // ========================================
    async function callAPI(action, data = {}) {
        try {
            const url = `${APPS_SCRIPT_URL}?action=${action}`;
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action, ...data })
            };
            
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            return { status: 'error', message: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi: ' + error.message };
        }
    }

    // ========================================
    // KH·ªûI T·∫†O
    // ========================================
    $(document).ready(() => {
        $(document).on('focus', '.money-input', function() { 
            let v = unMoney($(this).val()); 
            $(this).val(v === 0 ? '' : v); 
        });
        $(document).on('blur', '.money-input', function() { 
            $(this).val(money(unMoney($(this).val()))); 
        });
        
        loadData();
        setInterval(loadData, 180000); // Auto refresh 3 ph√∫t
    });

    // ========================================
    // T·∫¢I D·ªÆ LI·ªÜU
    // ========================================
    async function loadData() {
        try {
            updateStatus('loading', 'üîÑ ƒêang t·∫£i...');
            
            // T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu
            const dataRes = await callAPI('getAllData');
            if (dataRes.status !== 'success') throw new Error(dataRes.message);
            
            currentData = dataRes.data || [];
            
            // T·∫£i summary
            const summaryRes = await callAPI('getSummary');
            if (summaryRes.status === 'success') {
                const s = summaryRes.data;
                $('#tTotal').text(money(s.total) + 'ƒë');
                $('#tVatTu').text(money(s.vatTu) + 'ƒë');
                $('#tTienCong').text(money(s.tienCong) + 'ƒë');
                renderCostChart(s.vatTu, s.tienCong);
            }
            
            // T·∫£i staff summary
            const staffRes = await callAPI('getStaffSummary');
            if (staffRes.status === 'success') {
                renderStaffChart(staffRes.data);
            }
            
            // C·∫≠p nh·∫≠t b·∫£ng
            updateTable();
            
            $('#totalRows').text(currentData.length);
            $('#lastUpdate').text(new Date().toLocaleTimeString('vi-VN'));
            updateStatus('success', `‚úÖ ƒê√£ t·∫£i ${currentData.length} h√†ng`);
            
        } catch (error) {
            console.error('Load error:', error);
            updateStatus('error', '‚ùå L·ªói k·∫øt n·ªëi');
            showSampleData();
        }
    }

    function updateStatus(type, text) {
        const badge = $('#connectionStatus');
        badge.removeClass('status-success status-warning status-error');
        
        if (type === 'success') badge.addClass('status-success');
        else if (type === 'error') badge.addClass('status-error');
        else badge.addClass('status-warning');
        
        badge.text(text);
    }

    function updateTable() {
        if ($.fn.DataTable.isDataTable('#tbl')) $('#tbl').DataTable().destroy();
        
        let html = '';
        currentData.forEach(r => {
            html += `<tr>
                <td class="text-center text-muted small">${r[0]}</td>
                <td class="fw-bold text-nowrap">${r[1]}</td>
                <td>${r[2]}</td>
                <td class="money text-info">${money(r[3])}</td>
                <td class="money text-warning">${money(r[4])}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-warning border-0 action-btn" onclick="openEdit(${r[0]})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger border-0 action-btn" onclick="askDelete(${r[0]})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        
        $('#tbl tbody').html(html);
        $('#tbl').DataTable({ 
            order: [[0, "desc"]], 
            pageLength: 10,
            language: { url: "//cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json" }
        });
    }

    // ========================================
    // BI·ªÇU ƒê·ªí
    // ========================================
    function renderCostChart(v, t) {
        const ctx = document.getElementById('costChart');
        if(costChart) costChart.destroy();
        costChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['V·∫≠t t∆∞', 'Ti·ªÅn c√¥ng'],
                datasets: [{ data: [v, t], backgroundColor: ['#0dcaf0', '#ffc107'], hoverOffset: 12 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderStaffChart(s) {
        const ctx = document.getElementById('staffChart');
        if(staffChart) staffChart.destroy();
        staffChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Tri·ªÅu', 'T√®o', 'Thi·ªán', 'Thu·∫≠n'],
                datasets: [{
                    label: 'T·ªïng ti·ªÅn (ƒë)',
                    data: [s.trieu, s.teo, s.thien, s.thuan],
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'],
                    borderRadius: 6
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // ========================================
    // MODAL TH√äM/S·ª¨A
    // ========================================
    function openModal(mode) {
        $('#editId').val('');
        $('#date').val(new Date().toISOString().split('T')[0]);
        $('#content, #note').val('');
        $('.money-input').val('0');
        $('#mTitle').text('TH√äM M·ªöI CHI PH√ç');
        $('#saveBtn').text('L∆ØU D·ªÆ LI·ªÜU').removeClass('btn-warning').addClass('btn-primary').prop('disabled', false);
        $('#saveLoading').addClass('d-none');
        new bootstrap.Modal('#modal').show();
    }

    function openEdit(id) {
        const r = currentData.find(x => x[0] == id);
        if(!r) return;
        
        $('#editId').val(id);
        let dt = r[1].split('/');
        $('#date').val(`${dt[2]}-${dt[1]}-${dt[0]}`);
        $('#content').val(r[2]);
        $('#vatTu').val(money(r[3])); 
        $('#tienCong').val(money(r[4]));
        $('#note').val(r[5]);
        $('#trieu').val(money(r[6])); 
        $('#teo').val(money(r[7]));
        $('#thien').val(money(r[8])); 
        $('#thuan').val(money(r[9]));
        
        $('#mTitle').text('CH·ªàNH S·ª¨A B·∫¢N GHI #' + id);
        $('#saveBtn').text('C·∫¨P NH·∫¨T (C·∫¶N PASS)').removeClass('btn-primary').addClass('btn-warning');
        $('#saveLoading').addClass('d-none');
        new bootstrap.Modal('#modal').show();
    }

    // ========================================
    // L∆ØU D·ªÆ LI·ªÜU
    // ========================================
    async function save() {
        const id = $('#editId').val();
        const data = {
            date: $('#date').val().split('-').reverse().join('/'),
            content: $('#content').val().trim(),
            vatTu: unMoney($('#vatTu').val()),
            tienCong: unMoney($('#tienCong').val()),
            note: $('#note').val(),
            trieu: unMoney($('#trieu').val()),
            teo: unMoney($('#teo').val()),
            thien: unMoney($('#thien').val()),
            thuan: unMoney($('#thuan').val())
        };
        
        if(!data.content || !data.date) return alert("Vui l√≤ng nh·∫≠p Ng√†y v√† N·ªôi dung!");

        if(id) {
            // C·∫≠p nh·∫≠t
            tempSave = data; 
            targetId = id; 
            currentAction = 'edit';
            $('#authTxt').text('B·∫°n ƒëang thay ƒë·ªïi d·ªØ li·ªáu c·ªßa ID #' + id);
            bootstrap.Modal.getInstance('#modal').hide();
            new bootstrap.Modal('#loginModal').show();
        } else {
            // Th√™m m·ªõi
            $('#saveBtn').prop('disabled', true).text('ƒêang l∆∞u...');
            $('#saveLoading').removeClass('d-none');
            
            const result = await callAPI('saveNew', { data: JSON.stringify(data) });
            
            if(result.status === 'success') {
                alert(result.message || 'ƒê√£ l∆∞u v√† g·ª≠i email th√¥ng b√°o!');
                await loadData();
                bootstrap.Modal.getInstance('#modal').hide();
            } else {
                alert('L·ªói: ' + result.message);
                $('#saveBtn').prop('disabled', false).text('L∆ØU TH√îNG TIN');
                $('#saveLoading').addClass('d-none');
            }
        }
    }

    // ========================================
    // X√ìA
    // ========================================
    function askDelete(id) {
        targetId = id; 
        currentAction = 'delete';
        $('#authTxt').text('H√†nh ƒë·ªông x√≥a ID #' + id + ' s·∫Ω g·ª≠i mail b√°o c√°o v√† kh√¥ng th·ªÉ ho√†n t√°c!');
        new bootstrap.Modal('#loginModal').show();
    }

    // ========================================
    // X√ÅC TH·ª∞C
    // ========================================
    async function confirmAuth() {
        const pass = $('#authPass').val();
        if(!pass) return alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!");
        
        $('#authLoading').removeClass('d-none');
        
        let result;
        if(currentAction === 'edit') {
            result = await callAPI('update', {
                id: targetId,
                data: JSON.stringify(tempSave),
                user: 'Admin',
                pass: pass
            });
        } else {
            result = await callAPI('delete', {
                id: targetId,
                user: 'Admin',
                pass: pass
            });
        }
        
        $('#authLoading').addClass('d-none');
        
        if(result.status === 'success') {
            alert(result.message);
            bootstrap.Modal.getInstance('#loginModal').hide();
            $('#authPass').val('');
            await loadData();
        } else {
            alert('L·ªói: ' + result.message);
        }
    }

    // ========================================
    // D·ªÆ LI·ªÜU M·∫™U (CHO TEST)
    // ========================================
    function showSampleData() {
        currentData = [
            [1, '01/01/2024', 'Mua ph√¢n b√≥n', 500000, 300000, 'Test', 150000, 150000, 0, 0],
            [2, '02/01/2024', 'Thu√™ m√°y c√†y', 0, 1000000, '', 500000, 500000, 0, 0],
            [3, '03/01/2024', 'Mua c√¢y gi·ªëng', 800000, 200000, '', 100000, 100000, 0, 0]
        ];
        
        updateTable();
        $('#tTotal').text(money(2800000) + 'ƒë');
        $('#tVatTu').text(money(1300000) + 'ƒë');
        $('#tTienCong').text(money(1500000) + 'ƒë');
        
        renderCostChart(1300000, 1500000);
        renderStaffChart({ trieu: 750000, teo: 750000, thien: 0, thuan: 0 });
        
        updateStatus('warning', '‚ö†Ô∏è D·ªØ li·ªáu m·∫´u');
    }
</script>
</body>
</html>
